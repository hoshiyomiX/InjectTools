name: Termux Build & Release

on:
  push:
    tags:
      - 'termux-v*.*.*'
  workflow_dispatch:
    inputs:
      version:
        description: 'Release version (e.g., termux-v2.3.1)'
        required: true
        default: 'termux-v2.3.1'

env:
  CARGO_TERM_COLOR: always
  CARGO_INCREMENTAL: 0

permissions:
  contents: write

jobs:
  build-termux:
    name: Build for Termux (${{ matrix.target }})
    runs-on: ubuntu-latest
    
    strategy:
      fail-fast: false
      matrix:
        include:
          - target: aarch64-linux-android
            arch: aarch64
            api: 30
            asset_name: injecttools-termux-arm64
          
          - target: armv7-linux-androideabi
            arch: armv7a
            api: 30
            asset_name: injecttools-termux-armv7

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Install Rust toolchain
        uses: dtolnay/rust-toolchain@stable
        with:
          targets: ${{ matrix.target }}

      - name: Cache cargo
        uses: actions/cache@v4
        with:
          path: |
            ~/.cargo/registry
            ~/.cargo/git
            target
          key: ${{ runner.os }}-cargo-${{ matrix.target }}-${{ hashFiles('**/Cargo.lock') }}

      - name: Download Android NDK
        run: |
          echo "ğŸ“¥ Downloading NDK r26d..."
          wget -q https://dl.google.com/android/repository/android-ndk-r26d-linux.zip
          
          echo "ğŸ“‚ Extracting..."
          unzip -q android-ndk-r26d-linux.zip
          
          echo "ANDROID_NDK_HOME=$PWD/android-ndk-r26d" >> $GITHUB_ENV
          echo "âœ… NDK ready"

      - name: Configure Android toolchain
        run: |
          NDK_BIN="$ANDROID_NDK_HOME/toolchains/llvm/prebuilt/linux-x86_64/bin"
          
          echo "CC_aarch64_linux_android=${NDK_BIN}/aarch64-linux-android${{ matrix.api }}-clang" >> $GITHUB_ENV
          echo "AR_aarch64_linux_android=${NDK_BIN}/llvm-ar" >> $GITHUB_ENV
          echo "CARGO_TARGET_AARCH64_LINUX_ANDROID_LINKER=${NDK_BIN}/aarch64-linux-android${{ matrix.api }}-clang" >> $GITHUB_ENV
          
          echo "CC_armv7_linux_androideabi=${NDK_BIN}/armv7a-linux-androideabi${{ matrix.api }}-clang" >> $GITHUB_ENV
          echo "AR_armv7_linux_androideabi=${NDK_BIN}/llvm-ar" >> $GITHUB_ENV
          echo "CARGO_TARGET_ARMV7_LINUX_ANDROIDEABI_LINKER=${NDK_BIN}/armv7a-linux-androideabi${{ matrix.api }}-clang" >> $GITHUB_ENV
          
          echo "ğŸ”§ Toolchain configured"

      - name: Build binary
        run: |
          echo "ğŸ”¨ Building for ${{ matrix.target }}..."
          cargo build --release --target ${{ matrix.target }}
          echo "âœ… Build complete"
          
          ls -lh target/${{ matrix.target }}/release/injecttools

      - name: Strip binary
        run: |
          echo "âœ‚ï¸  Stripping debug symbols..."
          
          BEFORE=$(stat -c%s target/${{ matrix.target }}/release/injecttools)
          
          $ANDROID_NDK_HOME/toolchains/llvm/prebuilt/linux-x86_64/bin/llvm-strip \
            target/${{ matrix.target }}/release/injecttools
          
          AFTER=$(stat -c%s target/${{ matrix.target }}/release/injecttools)
          SAVED=$((BEFORE - AFTER))
          
          echo "Before: $(numfmt --to=iec-i --suffix=B $BEFORE)"
          echo "After:  $(numfmt --to=iec-i --suffix=B $AFTER)"
          echo "Saved:  $(numfmt --to=iec-i --suffix=B $SAVED)"

      - name: Package binary
        run: |
          echo "ğŸ“¦ Packaging..."
          
          cd target/${{ matrix.target }}/release
          tar czf ../../../${{ matrix.asset_name }}.tar.gz injecttools
          cd ../../..
          
          sha256sum ${{ matrix.asset_name }}.tar.gz | tee ${{ matrix.asset_name }}.tar.gz.sha256
          
          ls -lh ${{ matrix.asset_name }}.tar.gz

      - name: Upload artifacts
        uses: actions/upload-artifact@v4
        with:
          name: ${{ matrix.asset_name }}
          path: |
            ${{ matrix.asset_name }}.tar.gz
            ${{ matrix.asset_name }}.tar.gz.sha256

  create-release:
    name: Create Release
    needs: build-termux
    runs-on: ubuntu-latest
    permissions:
      contents: write
      
    steps:
      - uses: actions/checkout@v4
      
      - name: Download artifacts
        uses: actions/download-artifact@v4
        with:
          path: artifacts
      
      - name: Prepare release
        run: |
          mkdir -p release-assets
          find artifacts -name "*.tar.gz" -exec cp {} release-assets/ \;
          find artifacts -name "*.sha256" -exec cp {} release-assets/ \;
          
          cd release-assets
          cat *.sha256 > checksums.txt
          ls -lh
      
      - name: Get version
        id: version
        run: |
          if [ "${{ github.event_name }}" = "workflow_dispatch" ]; then
            echo "version=${{ github.event.inputs.version }}" >> $GITHUB_OUTPUT
          else
            echo "version=${GITHUB_REF#refs/tags/}" >> $GITHUB_OUTPUT
          fi
      
      - name: Create release
        uses: softprops/action-gh-release@v1
        with:
          tag_name: ${{ steps.version.outputs.version }}
          name: InjectTools ${{ steps.version.outputs.version }}
          body: |
            # InjectTools ${{ steps.version.outputs.version }} - Termux
            
            Bug Inject Scanner for Cloudflare - Rust Edition
            
            ## âœ¨ Quick Install
            ```bash
            curl -sSL https://raw.githubusercontent.com/hoshiyomiX/InjectTools/main/install.sh | bash
            ```
            
            ## ğŸ“¦ Manual Install
            
            | Device | Arch | File |
            |--------|------|------|
            | Modern Android (2018+) | ARM64 | `injecttools-termux-arm64.tar.gz` |
            | Older Android (2015-2018) | ARMv7 | `injecttools-termux-armv7.tar.gz` |
            
            **Check:** `uname -m` â†’ `aarch64` = ARM64, `armv7l` = ARMv7
            
            ```bash
            # Download, extract, install
            wget https://github.com/hoshiyomiX/InjectTools/releases/download/${{ steps.version.outputs.version }}/injecttools-termux-arm64.tar.gz
            tar xzf injecttools-termux-arm64.tar.gz
            mv injecttools $PREFIX/bin/
            chmod +x $PREFIX/bin/injecttools
            ```
            
            ## ğŸš€ Features v2.3
            - âš¡ Async concurrent scanning
            - ğŸ” Single subdomain test
            - ğŸ“š Batch testing (manual + file)
            - ğŸŒ Full scan with crt.sh
            - ğŸ“Š Results viewer & export
            - ğŸ“ Ping test (HTTP fallback on Android)
            - â˜ï¸  Cloudflare detection
            - ğŸ¨ Colorful TUI
            - â¹ï¸  Ctrl+C cancellation
            
            ## ğŸ” Checksums (SHA256)
            ```
            $(cat release-assets/checksums.txt)
            ```
            
            ## ğŸ› Bug Fixes in v2.3.1
            - âœ… Fixed Android build error (surge-ping conditional compilation)
            - âœ… HTTP fallback ping for Android (no root required)
            - âœ… Simplified build logs
            
            ---
            
            **Created by:** [@hoshiyomi_id](https://t.me/hoshiyomi_id)  
            **License:** MIT  
            **Issues:** [Report bugs](https://github.com/hoshiyomiX/InjectTools/issues)
          files: release-assets/*
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
