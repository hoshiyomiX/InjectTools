name: Termux Build & Release

on:
  push:
    tags:
      - 'termux-v*.*.*'
  workflow_dispatch:
    inputs:
      version:
        description: 'Release version (e.g., termux-v2.3.1)'
        required: true
        default: 'termux-v2.3.1'

env:
  CARGO_TERM_COLOR: always

permissions:
  contents: write

jobs:
  build-termux:
    name: Build for Termux (${{ matrix.target }})
    runs-on: ubuntu-latest
    
    permissions:
      contents: write
    
    strategy:
      fail-fast: false
      matrix:
        include:
          - target: aarch64-linux-android
            arch: aarch64
            api: 30
            asset_name: injecttools-termux-arm64
          
          - target: armv7-linux-androideabi
            arch: armv7a
            api: 30
            asset_name: injecttools-termux-armv7

    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          token: ${{ secrets.GITHUB_TOKEN }}
          fetch-depth: 0

      - name: Setup build logging
        run: |
          # Logs di root repo biar jelas
          mkdir -p build-logs
          
          TIMESTAMP=$(date +%Y%m%d-%H%M%S)
          BUILD_LOG="build-logs/build-${{ matrix.arch }}-${TIMESTAMP}.log"
          
          echo "BUILD_LOG=$BUILD_LOG" >> $GITHUB_ENV
          echo "BUILD_TIMESTAMP=$TIMESTAMP" >> $GITHUB_ENV
          
          # Create header
          cat > "$BUILD_LOG" << 'EOFLOG'
â•”â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•—
â•‘          InjectTools Termux Build Log                        â•‘
â•šâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
EOFLOG
          
          cat >> "$BUILD_LOG" << EOF

Build Information:
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
Target: ${{ matrix.target }}
Architecture: ${{ matrix.arch }}
Android API: ${{ matrix.api }}
Runner: ubuntu-latest
Rust: $(rustc --version 2>&1 || echo 'installing...')
Cargo: $(cargo --version 2>&1 || echo 'installing...')

Trigger: ${{ github.event_name }}
Commit: ${{ github.sha }}
Ref: ${{ github.ref }}
Actor: ${{ github.actor }}

Started: $(date -u +'%Y-%m-%d %H:%M:%S UTC')

â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

EOF
          
          echo "âœ… Log initialized: $BUILD_LOG"

      - name: Install Rust toolchain
        uses: dtolnay/rust-toolchain@stable
        with:
          targets: ${{ matrix.target }}

      - name: Cache cargo
        uses: actions/cache@v4
        with:
          path: |
            ~/.cargo/registry
            ~/.cargo/git
            target
          key: ${{ runner.os }}-cargo-${{ matrix.target }}-${{ hashFiles('**/Cargo.lock') }}

      - name: Download Android NDK
        run: |
          {
            echo "[$(date +'%H:%M:%S')] ğŸ“¦ Downloading NDK r26d..."
            wget -q --show-progress https://dl.google.com/android/repository/android-ndk-r26d-linux.zip
            
            echo "[$(date +'%H:%M:%S')] ğŸ“‚ Extracting..."
            unzip -q android-ndk-r26d-linux.zip
            
            echo "ANDROID_NDK_HOME=$PWD/android-ndk-r26d" >> $GITHUB_ENV
            echo "[$(date +'%H:%M:%S')] âœ… NDK ready"
            echo ""
          } 2>&1 | tee -a "$BUILD_LOG"

      - name: Configure Android toolchain
        run: |
          {
            echo "[$(date +'%H:%M:%S')] âš™ï¸ Configuring toolchain..."
            
            NDK_BIN="$ANDROID_NDK_HOME/toolchains/llvm/prebuilt/linux-x86_64/bin"
            
            # aarch64
            echo "CC_aarch64_linux_android=${NDK_BIN}/aarch64-linux-android${{ matrix.api }}-clang" >> $GITHUB_ENV
            echo "AR_aarch64_linux_android=${NDK_BIN}/llvm-ar" >> $GITHUB_ENV
            echo "CARGO_TARGET_AARCH64_LINUX_ANDROID_LINKER=${NDK_BIN}/aarch64-linux-android${{ matrix.api }}-clang" >> $GITHUB_ENV
            
            # armv7
            echo "CC_armv7_linux_androideabi=${NDK_BIN}/armv7a-linux-androideabi${{ matrix.api }}-clang" >> $GITHUB_ENV
            echo "AR_armv7_linux_androideabi=${NDK_BIN}/llvm-ar" >> $GITHUB_ENV
            echo "CARGO_TARGET_ARMV7_LINUX_ANDROIDEABI_LINKER=${NDK_BIN}/armv7a-linux-androideabi${{ matrix.api }}-clang" >> $GITHUB_ENV
            
            echo "[$(date +'%H:%M:%S')] âœ… Toolchain configured"
            echo ""
          } 2>&1 | tee -a "$BUILD_LOG"

      - name: Build binary
        id: build
        continue-on-error: true
        run: |
          {
            echo "[$(date +'%H:%M:%S')] ğŸ”¨ Building for ${{ matrix.target }}..."
            echo ""
            
            if cargo build --release --target ${{ matrix.target }} 2>&1; then
              echo ""
              echo "[$(date +'%H:%M:%S')] âœ… BUILD SUCCESS"
              echo "BUILD_STATUS=success" >> $GITHUB_OUTPUT
            else
              echo ""
              echo "[$(date +'%H:%M:%S')] âŒ BUILD FAILED (exit: $?)"
              echo "BUILD_STATUS=failed" >> $GITHUB_OUTPUT
              exit 1
            fi
            
            echo ""
            ls -lh target/${{ matrix.target }}/release/injecttools 2>&1 || echo "âš ï¸ Binary not found"
            echo ""
          } 2>&1 | tee -a "$BUILD_LOG"

      - name: Strip binary
        if: steps.build.outputs.BUILD_STATUS == 'success'
        run: |
          {
            echo "[$(date +'%H:%M:%S')] âœ‚ï¸ Stripping..."
            
            BEFORE=$(stat -c%s target/${{ matrix.target }}/release/injecttools)
            
            $ANDROID_NDK_HOME/toolchains/llvm/prebuilt/linux-x86_64/bin/llvm-strip \
              target/${{ matrix.target }}/release/injecttools
            
            AFTER=$(stat -c%s target/${{ matrix.target }}/release/injecttools)
            SAVED=$((BEFORE - AFTER))
            
            echo "  Before: $(numfmt --to=iec-i --suffix=B $BEFORE)"
            echo "  After:  $(numfmt --to=iec-i --suffix=B $AFTER)"
            echo "  Saved:  $(numfmt --to=iec-i --suffix=B $SAVED)"
            echo ""
          } 2>&1 | tee -a "$BUILD_LOG"

      - name: Package binary
        if: steps.build.outputs.BUILD_STATUS == 'success'
        run: |
          {
            echo "[$(date +'%H:%M:%S')] ğŸ“¦ Packaging..."
            
            cd target/${{ matrix.target }}/release
            tar czf ../../../${{ matrix.asset_name }}.tar.gz injecttools
            cd ../../..
            
            sha256sum ${{ matrix.asset_name }}.tar.gz | tee ${{ matrix.asset_name }}.tar.gz.sha256
            
            ls -lh ${{ matrix.asset_name }}.tar.gz
            echo ""
          } 2>&1 | tee -a "$BUILD_LOG"

      - name: Finalize log
        if: always()
        run: |
          {
            echo "â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"
            echo ""
            echo "Build Summary"
            echo "â•â•â•â•â•â•â•â•â•â•â•â•â•"
            echo "Status:   ${{ steps.build.outputs.BUILD_STATUS || 'FAILED' }}"
            echo "Finished: $(date -u +'%Y-%m-%d %H:%M:%S UTC')"
            echo "Duration: ${SECONDS}s"
            echo ""
            
            if [ "${{ steps.build.outputs.BUILD_STATUS }}" = "success" ]; then
              echo "âœ… SUCCESS - Artifacts ready"
            else
              echo "âŒ FAILED - Check logs above"
            fi
            
            echo ""
            echo "â•”â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•—"
            echo "â•‘                    End of Build Log                          â•‘"
            echo "â•šâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"
          } 2>&1 | tee -a "$BUILD_LOG"
          
          echo ""
          echo "ğŸ“ Log file: $BUILD_LOG"
          ls -lh "$BUILD_LOG"

      - name: Push log to repo
        if: always()
        continue-on-error: true
        run: |
          # Git setup
          git config user.name "github-actions[bot]"
          git config user.email "41898282+github-actions[bot]@users.noreply.github.com"
          
          # Rename with status
          STATUS="${{ steps.build.outputs.BUILD_STATUS || 'failed' }}"
          FINAL_LOG="build-logs/${STATUS}-${{ matrix.arch }}-${BUILD_TIMESTAMP}.log"
          
          mv "$BUILD_LOG" "$FINAL_LOG"
          echo "âœ… Renamed: $FINAL_LOG"
          
          # Cleanup old logs (keep last 10)
          cd build-logs
          ls -t *-${{ matrix.arch }}-*.log 2>/dev/null | tail -n +11 | xargs -r rm -f
          cd ..
          
          # Commit
          git add build-logs/
          git commit -m "ci: Build log [$STATUS] ${{ matrix.arch }} - ${BUILD_TIMESTAMP}" || exit 0
          
          # Push with retry
          for i in {1..3}; do
            if git push; then
              echo "âœ… Log pushed to repo"
              break
            else
              echo "âš ï¸ Retry $i/3..."
              git pull --rebase || true
              sleep 2
            fi
          done

      - name: Upload log artifact
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: build-log-${{ matrix.arch }}-${{ env.BUILD_TIMESTAMP }}
          path: build-logs/*-${{ matrix.arch }}-*.log
          retention-days: 30
          if-no-files-found: warn

      - name: Upload build artifacts
        if: steps.build.outputs.BUILD_STATUS == 'success'
        uses: actions/upload-artifact@v4
        with:
          name: ${{ matrix.asset_name }}
          path: |
            ${{ matrix.asset_name }}.tar.gz
            ${{ matrix.asset_name }}.tar.gz.sha256

      - name: Fail if build failed
        if: steps.build.outputs.BUILD_STATUS != 'success'
        run: |
          echo "::error::Build failed for ${{ matrix.target }}"
          exit 1

  create-release:
    name: Create Release
    needs: build-termux
    runs-on: ubuntu-latest
    permissions:
      contents: write
      
    steps:
      - uses: actions/checkout@v4
      
      - name: Download artifacts
        uses: actions/download-artifact@v4
        with:
          path: artifacts
      
      - name: Prepare release
        run: |
          mkdir -p release-assets
          find artifacts -name "*.tar.gz" -exec cp {} release-assets/ \;
          find artifacts -name "*.sha256" -exec cp {} release-assets/ \;
          
          cd release-assets
          cat *.sha256 > checksums.txt
          ls -lh
      
      - name: Get version
        id: version
        run: |
          if [ "${{ github.event_name }}" = "workflow_dispatch" ]; then
            echo "version=${{ github.event.inputs.version }}" >> $GITHUB_OUTPUT
          else
            echo "version=${GITHUB_REF#refs/tags/}" >> $GITHUB_OUTPUT
          fi
      
      - name: Create release
        uses: softprops/action-gh-release@v1
        with:
          tag_name: ${{ steps.version.outputs.version }}
          name: InjectTools ${{ steps.version.outputs.version }}
          body: |
            # InjectTools ${{ steps.version.outputs.version }} - Termux
            
            ğŸ¤– Bug Inject Scanner for Cloudflare - Rust Edition
            
            ## ğŸ“¥ Quick Install
            ```bash
            curl -sSL https://raw.githubusercontent.com/hoshiyomiX/InjectTools/main/install.sh | bash
            ```
            
            ## ğŸ“¦ Manual Install
            
            | Device | Arch | File |
            |--------|------|------|
            | Modern Android | ARM64 | `injecttools-termux-arm64.tar.gz` |
            | Older Android | ARMv7 | `injecttools-termux-armv7.tar.gz` |
            
            Check: `uname -m`
            
            ## âœ¨ Features
            - âš¡ Async scanning
            - ğŸ” Cloudflare detection  
            - ğŸ“Š Progress bars
            - ğŸŒ crt.sh scanner
            - ğŸ“‹ Batch testing
            - ğŸ“ Results viewer
            - ğŸ“¡ Ping test
            - ğŸ¨ Colorful TUI
            
            ## ğŸ” Checksums
            ```
            $(cat release-assets/checksums.txt)
            ```
            
            ## ğŸ“ Build Logs
            - [View Logs](https://github.com/hoshiyomiX/InjectTools/tree/main/build-logs)
            
            **Created by:** [@hoshiyomi_id](https://t.me/hoshiyomi_id)
          files: release-assets/*
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}