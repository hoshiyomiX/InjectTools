name: Termux Build & Release

on:
  push:
    tags:
      - 'termux-v*.*.*'
  workflow_dispatch:
    inputs:
      version:
        description: 'Release version (e.g., termux-v2.3.1)'
        required: true
        default: 'termux-v2.3.1'

env:
  CARGO_TERM_COLOR: always
  CARGO_INCREMENTAL: 0
  RUST_BACKTRACE: 1

permissions:
  contents: write

jobs:
  build-termux:
    name: Build for Termux (${{ matrix.target }})
    runs-on: ubuntu-latest
    
    strategy:
      fail-fast: false
      matrix:
        include:
          - target: aarch64-linux-android
            arch: aarch64
            api: 30
            asset_name: injecttools-termux-arm64
          
          - target: armv7-linux-androideabi
            arch: armv7a
            api: 30
            asset_name: injecttools-termux-armv7

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Create build log directory
        run: |
          mkdir -p build-logs
          echo "Build started at $(date -u '+%Y-%m-%d %H:%M:%S UTC')" | tee build-logs/build-${{ matrix.target }}.log
          echo "Target: ${{ matrix.target }}" | tee -a build-logs/build-${{ matrix.target }}.log
          echo "Runner OS: ${{ runner.os }}" | tee -a build-logs/build-${{ matrix.target }}.log
          echo "========================================" | tee -a build-logs/build-${{ matrix.target }}.log

      - name: Install Rust toolchain
        uses: dtolnay/rust-toolchain@stable
        with:
          targets: ${{ matrix.target }}

      - name: Log Rust version
        run: |
          echo "" | tee -a build-logs/build-${{ matrix.target }}.log
          echo "ðŸ“¦ Rust Toolchain" | tee -a build-logs/build-${{ matrix.target }}.log
          echo "========================================" | tee -a build-logs/build-${{ matrix.target }}.log
          rustc --version | tee -a build-logs/build-${{ matrix.target }}.log
          cargo --version | tee -a build-logs/build-${{ matrix.target }}.log
          rustup target list --installed | tee -a build-logs/build-${{ matrix.target }}.log

      - name: Cache cargo
        uses: actions/cache@v4
        with:
          path: |
            ~/.cargo/registry
            ~/.cargo/git
            target
          key: ${{ runner.os }}-cargo-${{ matrix.target }}-${{ hashFiles('**/Cargo.lock') }}

      - name: Download Android NDK
        run: |
          echo "" | tee -a build-logs/build-${{ matrix.target }}.log
          echo "ðŸ“¥ Downloading Android NDK" | tee -a build-logs/build-${{ matrix.target }}.log
          echo "========================================" | tee -a build-logs/build-${{ matrix.target }}.log
          
          echo "Downloading NDK r26d..." | tee -a build-logs/build-${{ matrix.target }}.log
          wget -q https://dl.google.com/android/repository/android-ndk-r26d-linux.zip 2>&1 | tee -a build-logs/build-${{ matrix.target }}.log
          
          echo "Extracting NDK..." | tee -a build-logs/build-${{ matrix.target }}.log
          unzip -q android-ndk-r26d-linux.zip 2>&1 | tee -a build-logs/build-${{ matrix.target }}.log
          
          echo "ANDROID_NDK_HOME=$PWD/android-ndk-r26d" >> $GITHUB_ENV
          echo "NDK location: $PWD/android-ndk-r26d" | tee -a build-logs/build-${{ matrix.target }}.log
          echo "âœ… NDK ready" | tee -a build-logs/build-${{ matrix.target }}.log

      - name: Configure Android toolchain
        run: |
          echo "" | tee -a build-logs/build-${{ matrix.target }}.log
          echo "ðŸ”§ Configuring Toolchain" | tee -a build-logs/build-${{ matrix.target }}.log
          echo "========================================" | tee -a build-logs/build-${{ matrix.target }}.log
          
          NDK_BIN="$ANDROID_NDK_HOME/toolchains/llvm/prebuilt/linux-x86_64/bin"
          
          echo "CC_aarch64_linux_android=${NDK_BIN}/aarch64-linux-android${{ matrix.api }}-clang" >> $GITHUB_ENV
          echo "AR_aarch64_linux_android=${NDK_BIN}/llvm-ar" >> $GITHUB_ENV
          echo "CARGO_TARGET_AARCH64_LINUX_ANDROID_LINKER=${NDK_BIN}/aarch64-linux-android${{ matrix.api }}-clang" >> $GITHUB_ENV
          
          echo "CC_armv7_linux_androideabi=${NDK_BIN}/armv7a-linux-androideabi${{ matrix.api }}-clang" >> $GITHUB_ENV
          echo "AR_armv7_linux_androideabi=${NDK_BIN}/llvm-ar" >> $GITHUB_ENV
          echo "CARGO_TARGET_ARMV7_LINUX_ANDROIDEABI_LINKER=${NDK_BIN}/armv7a-linux-androideabi${{ matrix.api }}-clang" >> $GITHUB_ENV
          
          echo "NDK Binary Path: ${NDK_BIN}" | tee -a build-logs/build-${{ matrix.target }}.log
          echo "API Level: ${{ matrix.api }}" | tee -a build-logs/build-${{ matrix.target }}.log
          echo "âœ… Toolchain configured" | tee -a build-logs/build-${{ matrix.target }}.log

      - name: Build binary
        run: |
          echo "" | tee -a build-logs/build-${{ matrix.target }}.log
          echo "ðŸ”¨ Building Binary" | tee -a build-logs/build-${{ matrix.target }}.log
          echo "========================================" | tee -a build-logs/build-${{ matrix.target }}.log
          echo "Target: ${{ matrix.target }}" | tee -a build-logs/build-${{ matrix.target }}.log
          echo "Build started: $(date -u '+%Y-%m-%d %H:%M:%S UTC')" | tee -a build-logs/build-${{ matrix.target }}.log
          echo "" | tee -a build-logs/build-${{ matrix.target }}.log
          
          # Capture full build output
          if cargo build --release --target ${{ matrix.target }} 2>&1 | tee -a build-logs/build-${{ matrix.target }}.log; then
            echo "" | tee -a build-logs/build-${{ matrix.target }}.log
            echo "âœ… Build successful" | tee -a build-logs/build-${{ matrix.target }}.log
            echo "Build finished: $(date -u '+%Y-%m-%d %H:%M:%S UTC')" | tee -a build-logs/build-${{ matrix.target }}.log
          else
            echo "" | tee -a build-logs/build-${{ matrix.target }}.log
            echo "âŒ Build failed" | tee -a build-logs/build-${{ matrix.target }}.log
            exit 1
          fi
          
          echo "" | tee -a build-logs/build-${{ matrix.target }}.log
          echo "ðŸ“Š Binary Info:" | tee -a build-logs/build-${{ matrix.target }}.log
          ls -lh target/${{ matrix.target }}/release/injecttools | tee -a build-logs/build-${{ matrix.target }}.log
          file target/${{ matrix.target }}/release/injecttools | tee -a build-logs/build-${{ matrix.target }}.log

      - name: Strip binary
        run: |
          echo "" | tee -a build-logs/build-${{ matrix.target }}.log
          echo "âœ‚ï¸  Stripping Debug Symbols" | tee -a build-logs/build-${{ matrix.target }}.log
          echo "========================================" | tee -a build-logs/build-${{ matrix.target }}.log
          
          BEFORE=$(stat -c%s target/${{ matrix.target }}/release/injecttools)
          echo "Before strip: $(numfmt --to=iec-i --suffix=B $BEFORE)" | tee -a build-logs/build-${{ matrix.target }}.log
          
          $ANDROID_NDK_HOME/toolchains/llvm/prebuilt/linux-x86_64/bin/llvm-strip \
            target/${{ matrix.target }}/release/injecttools 2>&1 | tee -a build-logs/build-${{ matrix.target }}.log
          
          AFTER=$(stat -c%s target/${{ matrix.target }}/release/injecttools)
          SAVED=$((BEFORE - AFTER))
          
          echo "After strip:  $(numfmt --to=iec-i --suffix=B $AFTER)" | tee -a build-logs/build-${{ matrix.target }}.log
          echo "Saved:        $(numfmt --to=iec-i --suffix=B $SAVED) ($(( SAVED * 100 / BEFORE ))%)" | tee -a build-logs/build-${{ matrix.target }}.log
          echo "âœ… Strip complete" | tee -a build-logs/build-${{ matrix.target }}.log

      - name: Package binary
        run: |
          echo "" | tee -a build-logs/build-${{ matrix.target }}.log
          echo "ðŸ“¦ Packaging" | tee -a build-logs/build-${{ matrix.target }}.log
          echo "========================================" | tee -a build-logs/build-${{ matrix.target }}.log
          
          cd target/${{ matrix.target }}/release
          tar czf ../../../${{ matrix.asset_name }}.tar.gz injecttools 2>&1 | tee -a ../../../build-logs/build-${{ matrix.target }}.log
          cd ../../..
          
          sha256sum ${{ matrix.asset_name }}.tar.gz | tee ${{ matrix.asset_name }}.tar.gz.sha256 | tee -a build-logs/build-${{ matrix.target }}.log
          
          TARBALL_SIZE=$(stat -c%s ${{ matrix.asset_name }}.tar.gz)
          echo "Package size: $(numfmt --to=iec-i --suffix=B $TARBALL_SIZE)" | tee -a build-logs/build-${{ matrix.target }}.log
          echo "âœ… Packaging complete" | tee -a build-logs/build-${{ matrix.target }}.log

      - name: Finalize build log
        if: always()
        run: |
          echo "" | tee -a build-logs/build-${{ matrix.target }}.log
          echo "========================================" | tee -a build-logs/build-${{ matrix.target }}.log
          echo "Build finished at $(date -u '+%Y-%m-%d %H:%M:%S UTC')" | tee -a build-logs/build-${{ matrix.target }}.log
          
          # Compress log
          gzip -9 build-logs/build-${{ matrix.target }}.log
          
          echo "ðŸ“„ Build log created: build-${{ matrix.target }}.log.gz"
          ls -lh build-logs/

      - name: Upload artifacts
        uses: actions/upload-artifact@v4
        with:
          name: ${{ matrix.asset_name }}
          path: |
            ${{ matrix.asset_name }}.tar.gz
            ${{ matrix.asset_name }}.tar.gz.sha256
            build-logs/build-${{ matrix.target }}.log.gz

  create-release:
    name: Create Release
    needs: build-termux
    runs-on: ubuntu-latest
    permissions:
      contents: write
      
    steps:
      - uses: actions/checkout@v4
      
      - name: Download artifacts
        uses: actions/download-artifact@v4
        with:
          path: artifacts
      
      - name: Prepare release
        run: |
          mkdir -p release-assets
          find artifacts -name "*.tar.gz" -exec cp {} release-assets/ \;
          find artifacts -name "*.sha256" -exec cp {} release-assets/ \;
          find artifacts -name "*.log.gz" -exec cp {} release-assets/ \;
          
          cd release-assets
          cat *.sha256 > checksums.txt
          
          echo "ðŸ“¦ Release Assets:"
          ls -lh
      
      - name: Get version
        id: version
        run: |
          if [ "${{ github.event_name }}" = "workflow_dispatch" ]; then
            echo "version=${{ github.event.inputs.version }}" >> $GITHUB_OUTPUT
          else
            echo "version=${GITHUB_REF#refs/tags/}" >> $GITHUB_OUTPUT
          fi
      
      - name: Create release
        uses: softprops/action-gh-release@v1
        with:
          tag_name: ${{ steps.version.outputs.version }}
          name: InjectTools ${{ steps.version.outputs.version }}
          body: |
            # InjectTools ${{ steps.version.outputs.version }} - Termux Edition
            
            ðŸ¤– **Bug Inject Scanner for Cloudflare Subdomains** - High-performance Rust implementation
            
            ## âœ¨ Quick Install
            
            ```bash
            curl -sSL https://raw.githubusercontent.com/hoshiyomiX/InjectTools/main/install.sh | bash
            ```
            
            ## ðŸ“¦ Manual Install
            
            | Device Type | Architecture | Download |
            |-------------|--------------|----------|
            | **Modern Android** (2018+) | ARM64 (aarch64) | `injecttools-termux-arm64.tar.gz` |
            | **Older Android** (2015-2018) | ARMv7 | `injecttools-termux-armv7.tar.gz` |
            
            **Check your architecture:**
            ```bash
            uname -m
            # aarch64 = ARM64 (use arm64)
            # armv7l/armv8l = ARMv7 (use armv7)
            ```
            
            **Installation steps:**
            ```bash
            # Download
            wget https://github.com/hoshiyomiX/InjectTools/releases/download/${{ steps.version.outputs.version }}/injecttools-termux-arm64.tar.gz
            
            # Extract & Install
            tar xzf injecttools-termux-arm64.tar.gz
            mv injecttools $PREFIX/bin/
            chmod +x $PREFIX/bin/injecttools
            
            # Run
            injecttools
            ```
            
            ## ðŸš€ Features v2.3
            
            - âš¡ **Async Concurrent Scanning** - Powered by Tokio
            - ðŸ” **Single Subdomain Test** - Quick testing
            - ðŸŒ **crt.sh Integration** - Auto-discover subdomains
            - ðŸ“š **Batch Testing** - Test from file (manual + auto)
            - ðŸ“Š **Full Domain Scan** - Common subdomains
            - ðŸ“„ **Export Results** - Timestamped result files
            - ðŸ—‚ï¸  **View Results** - Browse past scans
            - â˜ï¸  **Cloudflare Detection** - Auto-detect CF IPs
            - ðŸŽ¨ **Colorful TUI** - Beautiful terminal UI
            - â¹ï¸  **Ctrl+C Handling** - Graceful cancellation
            
            ## ðŸ“‹ Menu Options
            
            1. ðŸŽ¯ Test Target Host
            2. ðŸ” Test Single Subdomain
            3. ðŸŒ Fetch & Test dari crt.sh
            4. ðŸ“¦ Batch Test dari File
            5. ðŸš€ Full Domain Scan
            6. ðŸ“Š View Exported Results
            7. âš™ï¸  Settings
            8. ðŸšª Exit
            
            ## ðŸ” Checksums (SHA256)
            
            ```
            $(cat release-assets/checksums.txt)
            ```
            
            ## ðŸ“ Build Logs
            
            Detailed build logs included:
            - `build-aarch64-linux-android.log.gz` - ARM64 build log
            - `build-armv7-linux-androideabi.log.gz` - ARMv7 build log
            
            ## ðŸ› Troubleshooting
            
            **Permission denied:**
            ```bash
            chmod +x $PREFIX/bin/injecttools
            ```
            
            **curl not found:**
            ```bash
            pkg install curl
            ```
            
            **DNS errors:**
            ```bash
            pkg install dnsutils
            ```
            
            **SSL/TLS errors:**
            ```bash
            pkg install ca-certificates openssl
            ```
            
            ---
            
            **Created by:** [@hoshiyomi_id](https://t.me/hoshiyomi_id)  
            **License:** MIT  
            **Build Date:** $(date -u '+%Y-%m-%d %H:%M:%S UTC')  
            
            ðŸ“– **Docs:** [README.md](https://github.com/hoshiyomiX/InjectTools#readme)  
            ðŸ› **Issues:** [Report bugs](https://github.com/hoshiyomiX/InjectTools/issues)
          files: release-assets/*
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

      - name: Release summary
        run: |
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "## ðŸŽ‰ Release Created Successfully!" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "**Version:** ${{ steps.version.outputs.version }}" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### ðŸ“¦ Built Targets" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "- âœ… ARM64 (aarch64-linux-android)" >> $GITHUB_STEP_SUMMARY
          echo "- âœ… ARMv7 (armv7-linux-androideabi)" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### ðŸ“¥ Downloads" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          cd release-assets
          for file in *.tar.gz; do
            SIZE=$(stat -c%s "$file")
            echo "- ðŸ“¦ [$file](https://github.com/hoshiyomiX/InjectTools/releases/download/${{ steps.version.outputs.version }}/$file) ($(numfmt --to=iec-i --suffix=B $SIZE))" >> $GITHUB_STEP_SUMMARY
          done
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### ðŸ“„ Build Logs" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          for log in *.log.gz; do
            SIZE=$(stat -c%s "$log")
            echo "- ðŸ“ [$log](https://github.com/hoshiyomiX/InjectTools/releases/download/${{ steps.version.outputs.version }}/$log) ($(numfmt --to=iec-i --suffix=B $SIZE))" >> $GITHUB_STEP_SUMMARY
          done