name: Termux Build & Release

on:
  push:
    tags:
      - 'termux-v*.*.*'
  workflow_dispatch:
    inputs:
      version:
        description: 'Release version (e.g., termux-v2.3.0)'
        required: true
        default: 'termux-v2.3.0'

env:
  CARGO_TERM_COLOR: always
  CARGO_INCREMENTAL: 0
  RUST_BACKTRACE: 1

permissions:
  contents: write

jobs:
  build-arm64:
    name: Build ARM64
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout latest main branch
        uses: actions/checkout@v4
        with:
          ref: main
          token: ${{ secrets.GITHUB_TOKEN }}
          fetch-depth: 0

      - name: Verify checkout
        run: |
          echo "Current commit: $(git rev-parse HEAD)"
          echo "Current branch: $(git branch --show-current)"
          git log -1 --oneline

      - name: Create build log directory
        run: |
          mkdir -p build-logs
          echo "Build started at $(date -u '+%Y-%m-%d %H:%M:%S UTC')" | tee build-logs/build-aarch64-linux-android.log
          echo "Target: aarch64-linux-android" | tee -a build-logs/build-aarch64-linux-android.log
          echo "Git commit: $(git rev-parse HEAD)" | tee -a build-logs/build-aarch64-linux-android.log
          echo "========================================" | tee -a build-logs/build-aarch64-linux-android.log

      - name: Install Rust toolchain
        uses: dtolnay/rust-toolchain@stable
        with:
          targets: aarch64-linux-android

      - name: Cache cargo registry
        uses: actions/cache@v4
        with:
          path: |
            ~/.cargo/registry
            ~/.cargo/git
          key: ${{ runner.os }}-cargo-registry-${{ hashFiles('**/Cargo.lock') }}

      - name: Download Android NDK
        run: |
          echo "ğŸ“¥ Downloading Android NDK r26d..." | tee -a build-logs/build-aarch64-linux-android.log
          wget -q https://dl.google.com/android/repository/android-ndk-r26d-linux.zip 2>&1 | tee -a build-logs/build-aarch64-linux-android.log
          
          echo "ğŸ“¦ Extracting NDK..." | tee -a build-logs/build-aarch64-linux-android.log
          unzip -q android-ndk-r26d-linux.zip 2>&1 | tee -a build-logs/build-aarch64-linux-android.log
          
          echo "ANDROID_NDK_HOME=$PWD/android-ndk-r26d" >> $GITHUB_ENV
          echo "âœ… NDK ready" | tee -a build-logs/build-aarch64-linux-android.log

      - name: Configure toolchain
        run: |
          NDK_BIN="$ANDROID_NDK_HOME/toolchains/llvm/prebuilt/linux-x86_64/bin"
          
          echo "CC_aarch64_linux_android=${NDK_BIN}/aarch64-linux-android30-clang" >> $GITHUB_ENV
          echo "AR_aarch64_linux_android=${NDK_BIN}/llvm-ar" >> $GITHUB_ENV
          echo "CARGO_TARGET_AARCH64_LINUX_ANDROID_LINKER=${NDK_BIN}/aarch64-linux-android30-clang" >> $GITHUB_ENV
          
          echo "ğŸ”§ Toolchain configured" | tee -a build-logs/build-aarch64-linux-android.log

      - name: Force clean build
        run: |
          echo "ğŸ§¹ Cleaning previous builds..." | tee -a build-logs/build-aarch64-linux-android.log
          cargo clean 2>&1 | tee -a build-logs/build-aarch64-linux-android.log
          echo "âœ… Clean complete" | tee -a build-logs/build-aarch64-linux-android.log

      - name: Build binary
        id: build
        continue-on-error: true
        run: |
          set -o pipefail  # Enable pipefail untuk proper error detection
          
          echo "ğŸ”¨ Building..." | tee -a build-logs/build-aarch64-linux-android.log
          
          # Show version being built
          echo "Cargo.toml version:" | tee -a build-logs/build-aarch64-linux-android.log
          grep '^version' Cargo.toml | tee -a build-logs/build-aarch64-linux-android.log
          
          # Show main.rs menu count for verification
          echo "Main menu options:" | tee -a build-logs/build-aarch64-linux-android.log
          grep -c 'println!("[0-9]' src/main.rs | tee -a build-logs/build-aarch64-linux-android.log || echo "Could not count menu items" | tee -a build-logs/build-aarch64-linux-android.log
          
          # Build with proper error handling
          if cargo build --release --target aarch64-linux-android 2>&1 | tee -a build-logs/build-aarch64-linux-android.log; then
            # Verify binary exists
            if [ ! -f target/aarch64-linux-android/release/injecttools ]; then
              echo "âŒ Build failed - binary not found" | tee -a build-logs/build-aarch64-linux-android.log
              exit 1
            fi
            
            echo "âœ… Build successful" | tee -a build-logs/build-aarch64-linux-android.log
            ls -lh target/aarch64-linux-android/release/injecttools | tee -a build-logs/build-aarch64-linux-android.log
          else
            echo "âŒ Cargo build failed" | tee -a build-logs/build-aarch64-linux-android.log
            exit 1
          fi

      - name: Strip binary
        if: steps.build.outcome == 'success'
        run: |
          BEFORE=$(stat -c%s target/aarch64-linux-android/release/injecttools)
          echo "Before: $(numfmt --to=iec-i --suffix=B $BEFORE)" | tee -a build-logs/build-aarch64-linux-android.log
          
          $ANDROID_NDK_HOME/toolchains/llvm/prebuilt/linux-x86_64/bin/llvm-strip \
            target/aarch64-linux-android/release/injecttools
          
          AFTER=$(stat -c%s target/aarch64-linux-android/release/injecttools)
          echo "After: $(numfmt --to=iec-i --suffix=B $AFTER)" | tee -a build-logs/build-aarch64-linux-android.log

      - name: Package
        if: steps.build.outcome == 'success'
        run: |
          cd target/aarch64-linux-android/release
          tar czf ../../../injecttools-termux-arm64.tar.gz injecttools
          cd ../../..
          
          sha256sum injecttools-termux-arm64.tar.gz | tee injecttools-termux-arm64.tar.gz.sha256 | tee -a build-logs/build-aarch64-linux-android.log
          echo "Finished: $(date -u '+%Y-%m-%d %H:%M:%S UTC')" | tee -a build-logs/build-aarch64-linux-android.log

      - name: Finalize build log
        if: always()
        run: |
          echo "========================================" | tee -a build-logs/build-aarch64-linux-android.log
          echo "Build status: ${{ steps.build.outcome }}" | tee -a build-logs/build-aarch64-linux-android.log
          echo "Finished at: $(date -u '+%Y-%m-%d %H:%M:%S UTC')" | tee -a build-logs/build-aarch64-linux-android.log

      - name: Commit build log
        if: always()
        run: |
          git config --local user.email "github-actions[bot]@users.noreply.github.com"
          git config --local user.name "github-actions[bot]"
          
          git add build-logs/build-aarch64-linux-android.log
          
          if ! git diff --staged --quiet; then
            git commit -m "Update ARM64 build log - Status: ${{ steps.build.outcome }} [skip ci]"
            git push origin main
          else
            echo "No changes to commit"
          fi

      - name: Upload artifacts
        if: steps.build.outcome == 'success'
        uses: actions/upload-artifact@v4
        with:
          name: injecttools-termux-arm64
          path: |
            injecttools-termux-arm64.tar.gz
            injecttools-termux-arm64.tar.gz.sha256

      - name: Fail job if build failed
        if: steps.build.outcome != 'success'
        run: |
          echo "âŒ Build failed - check build logs for details"
          exit 1

  build-armv7:
    name: Build ARMv7
    runs-on: ubuntu-latest
    needs: build-arm64
    
    steps:
      - name: Checkout latest main branch
        uses: actions/checkout@v4
        with:
          ref: main
          token: ${{ secrets.GITHUB_TOKEN }}
          fetch-depth: 0

      - name: Verify checkout
        run: |
          echo "Current commit: $(git rev-parse HEAD)"
          echo "Current branch: $(git branch --show-current)"
          git log -1 --oneline

      - name: Create build log directory
        run: |
          mkdir -p build-logs
          echo "Build started at $(date -u '+%Y-%m-%d %H:%M:%S UTC')" | tee build-logs/build-armv7-linux-androideabi.log
          echo "Target: armv7-linux-androideabi" | tee -a build-logs/build-armv7-linux-androideabi.log
          echo "Git commit: $(git rev-parse HEAD)" | tee -a build-logs/build-armv7-linux-androideabi.log
          echo "========================================" | tee -a build-logs/build-armv7-linux-androideabi.log

      - name: Install Rust toolchain
        uses: dtolnay/rust-toolchain@stable
        with:
          targets: armv7-linux-androideabi

      - name: Cache cargo registry
        uses: actions/cache@v4
        with:
          path: |
            ~/.cargo/registry
            ~/.cargo/git
          key: ${{ runner.os }}-cargo-registry-${{ hashFiles('**/Cargo.lock') }}

      - name: Download Android NDK
        run: |
          echo "ğŸ“¥ Downloading Android NDK r26d..." | tee -a build-logs/build-armv7-linux-androideabi.log
          wget -q https://dl.google.com/android/repository/android-ndk-r26d-linux.zip 2>&1 | tee -a build-logs/build-armv7-linux-androideabi.log
          
          echo "ğŸ“¦ Extracting NDK..." | tee -a build-logs/build-armv7-linux-androideabi.log
          unzip -q android-ndk-r26d-linux.zip 2>&1 | tee -a build-logs/build-armv7-linux-androideabi.log
          
          echo "ANDROID_NDK_HOME=$PWD/android-ndk-r26d" >> $GITHUB_ENV
          echo "âœ… NDK ready" | tee -a build-logs/build-armv7-linux-androideabi.log

      - name: Configure toolchain
        run: |
          NDK_BIN="$ANDROID_NDK_HOME/toolchains/llvm/prebuilt/linux-x86_64/bin"
          
          echo "CC_armv7_linux_androideabi=${NDK_BIN}/armv7a-linux-androideabi30-clang" >> $GITHUB_ENV
          echo "AR_armv7_linux_androideabi=${NDK_BIN}/llvm-ar" >> $GITHUB_ENV
          echo "CARGO_TARGET_ARMV7_LINUX_ANDROIDEABI_LINKER=${NDK_BIN}/armv7a-linux-androideabi30-clang" >> $GITHUB_ENV
          
          echo "ğŸ”§ Toolchain configured" | tee -a build-logs/build-armv7-linux-androideabi.log

      - name: Force clean build
        run: |
          echo "ğŸ§¹ Cleaning previous builds..." | tee -a build-logs/build-armv7-linux-androideabi.log
          cargo clean 2>&1 | tee -a build-logs/build-armv7-linux-androideabi.log
          echo "âœ… Clean complete" | tee -a build-logs/build-armv7-linux-androideabi.log

      - name: Build binary
        id: build
        continue-on-error: true
        run: |
          set -o pipefail  # Enable pipefail untuk proper error detection
          
          echo "ğŸ”¨ Building..." | tee -a build-logs/build-armv7-linux-androideabi.log
          
          # Show version being built
          echo "Cargo.toml version:" | tee -a build-logs/build-armv7-linux-androideabi.log
          grep '^version' Cargo.toml | tee -a build-logs/build-armv7-linux-androideabi.log
          
          # Show main.rs menu count for verification
          echo "Main menu options:" | tee -a build-logs/build-armv7-linux-androideabi.log
          grep -c 'println!("[0-9]' src/main.rs | tee -a build-logs/build-armv7-linux-androideabi.log || echo "Could not count menu items" | tee -a build-logs/build-armv7-linux-androideabi.log
          
          # Build with proper error handling
          if cargo build --release --target armv7-linux-androideabi 2>&1 | tee -a build-logs/build-armv7-linux-androideabi.log; then
            # Verify binary exists
            if [ ! -f target/armv7-linux-androideabi/release/injecttools ]; then
              echo "âŒ Build failed - binary not found" | tee -a build-logs/build-armv7-linux-androideabi.log
              exit 1
            fi
            
            echo "âœ… Build successful" | tee -a build-logs/build-armv7-linux-androideabi.log
            ls -lh target/armv7-linux-androideabi/release/injecttools | tee -a build-logs/build-armv7-linux-androideabi.log
          else
            echo "âŒ Cargo build failed" | tee -a build-logs/build-armv7-linux-androideabi.log
            exit 1
          fi

      - name: Strip binary
        if: steps.build.outcome == 'success'
        run: |
          BEFORE=$(stat -c%s target/armv7-linux-androideabi/release/injecttools)
          echo "Before: $(numfmt --to=iec-i --suffix=B $BEFORE)" | tee -a build-logs/build-armv7-linux-androideabi.log
          
          $ANDROID_NDK_HOME/toolchains/llvm/prebuilt/linux-x86_64/bin/llvm-strip \
            target/armv7-linux-androideabi/release/injecttools
          
          AFTER=$(stat -c%s target/armv7-linux-androideabi/release/injecttools)
          echo "After: $(numfmt --to=iec-i --suffix=B $AFTER)" | tee -a build-logs/build-armv7-linux-androideabi.log

      - name: Package
        if: steps.build.outcome == 'success'
        run: |
          cd target/armv7-linux-androideabi/release
          tar czf ../../../injecttools-termux-armv7.tar.gz injecttools
          cd ../../..
          
          sha256sum injecttools-termux-armv7.tar.gz | tee injecttools-termux-armv7.tar.gz.sha256 | tee -a build-logs/build-armv7-linux-androideabi.log
          echo "Finished: $(date -u '+%Y-%m-%d %H:%M:%S UTC')" | tee -a build-logs/build-armv7-linux-androideabi.log

      - name: Finalize build log
        if: always()
        run: |
          echo "========================================" | tee -a build-logs/build-armv7-linux-androideabi.log
          echo "Build status: ${{ steps.build.outcome }}" | tee -a build-logs/build-armv7-linux-androideabi.log
          echo "Finished at: $(date -u '+%Y-%m-%d %H:%M:%S UTC')" | tee -a build-logs/build-armv7-linux-androideabi.log

      - name: Commit build log
        if: always()
        run: |
          git config --local user.email "github-actions[bot]@users.noreply.github.com"
          git config --local user.name "github-actions[bot]"
          
          git add build-logs/build-armv7-linux-androideabi.log
          
          if ! git diff --staged --quiet; then
            git commit -m "Update ARMv7 build log - Status: ${{ steps.build.outcome }} [skip ci]"
            git push origin main
          else
            echo "No changes to commit"
          fi

      - name: Upload artifacts
        if: steps.build.outcome == 'success'
        uses: actions/upload-artifact@v4
        with:
          name: injecttools-termux-armv7
          path: |
            injecttools-termux-armv7.tar.gz
            injecttools-termux-armv7.tar.gz.sha256

      - name: Fail job if build failed
        if: steps.build.outcome != 'success'
        run: |
          echo "âŒ Build failed - check build logs for details"
          exit 1

  create-release:
    name: Create Release
    needs: [build-arm64, build-armv7]
    runs-on: ubuntu-latest
    permissions:
      contents: write
      
    steps:
      - uses: actions/checkout@v4
        with:
          ref: main
      
      - name: Download artifacts
        uses: actions/download-artifact@v4
        with:
          path: artifacts
      
      - name: Prepare release
        run: |
          mkdir -p release-assets
          find artifacts -name "*.tar.gz" -exec cp {} release-assets/ \;
          find artifacts -name "*.sha256" -exec cp {} release-assets/ \;
          
          cd release-assets
          cat *.sha256 > checksums.txt
          
          echo "ğŸ“¦ Release Assets:"
          ls -lh
      
      - name: Get version
        id: version
        run: |
          if [ "${{ github.event_name }}" = "workflow_dispatch" ]; then
            echo "version=${{ github.event.inputs.version }}" >> $GITHUB_OUTPUT
          else
            echo "version=${GITHUB_REF#refs/tags/}" >> $GITHUB_OUTPUT
          fi
      
      - name: Create release
        uses: softprops/action-gh-release@v1
        with:
          tag_name: ${{ steps.version.outputs.version }}
          name: InjectTools ${{ steps.version.outputs.version }}
          body: |
            # InjectTools ${{ steps.version.outputs.version }} - Termux Edition
            
            ğŸ¤– **Bug Inject Scanner for Cloudflare Subdomains** - High-performance Rust implementation
            
            ## âœ¨ Quick Install
            
            ```bash
            curl -sSL https://raw.githubusercontent.com/hoshiyomiX/InjectTools/main/install.sh | bash
            ```
            
            ## ğŸ“¦ Manual Install
            
            **Check architecture:**
            ```bash
            uname -m
            # aarch64 = ARM64, armv7l = ARMv7
            ```
            
            **ARM64:**
            ```bash
            wget https://github.com/hoshiyomiX/InjectTools/releases/download/${{ steps.version.outputs.version }}/injecttools-termux-arm64.tar.gz
            tar xzf injecttools-termux-arm64.tar.gz && mv injecttools $PREFIX/bin/ && chmod +x $PREFIX/bin/injecttools
            ```
            
            **ARMv7:**
            ```bash
            wget https://github.com/hoshiyomiX/InjectTools/releases/download/${{ steps.version.outputs.version }}/injecttools-termux-armv7.tar.gz
            tar xzf injecttools-termux-armv7.tar.gz && mv injecttools $PREFIX/bin/ && chmod +x $PREFIX/bin/injecttools
            ```
            
            ## ğŸš€ Features v2.3
            
            - âš¡ Async scanning
            - ğŸŒ crt.sh integration
            - ğŸ“¦ Batch testing
            - ğŸ“„ Export/view results
            - â˜ï¸ Cloudflare detection
            - â¹ï¸ Ctrl+C handling
            
            ## ğŸ” Checksums
            
            ```
            $(cat release-assets/checksums.txt)
            ```
            
            ## ğŸ“ Build Logs
            
            - [ARM64 build log](https://github.com/hoshiyomiX/InjectTools/blob/main/build-logs/build-aarch64-linux-android.log)
            - [ARMv7 build log](https://github.com/hoshiyomiX/InjectTools/blob/main/build-logs/build-armv7-linux-androideabi.log)
            
            ---
            
            **By:** [@hoshiyomi_id](https://t.me/hoshiyomi_id) | **License:** MIT
          files: release-assets/*
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}