name: Termux Build & Release

on:
  push:
    tags:
      - 'termux-v*.*.*'
  workflow_dispatch:
    inputs:
      version:
        description: 'Release version (e.g., termux-v2.3.0)'
        required: true
        default: 'termux-v2.3.0'

env:
  CARGO_TERM_COLOR: always

jobs:
  build-termux:
    name: Build for Termux (${{ matrix.target }})
    runs-on: ubuntu-latest
    strategy:
      fail-fast: false
      matrix:
        include:
          - target: aarch64-linux-android
            arch: aarch64
            api: 30
            asset_name: injecttools-termux-arm64
          
          - target: armv7-linux-androideabi
            arch: armv7a
            api: 30
            asset_name: injecttools-termux-armv7

    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          token: ${{ secrets.GITHUB_TOKEN }}

      - name: Install Rust toolchain
        uses: dtolnay/rust-toolchain@stable
        with:
          targets: ${{ matrix.target }}

      - name: Cache cargo registry
        uses: actions/cache@v4
        with:
          path: ~/.cargo/registry
          key: ${{ runner.os }}-cargo-registry-${{ hashFiles('**/Cargo.lock') }}

      - name: Cache cargo index
        uses: actions/cache@v4
        with:
          path: ~/.cargo/git
          key: ${{ runner.os }}-cargo-git-${{ hashFiles('**/Cargo.lock') }}

      - name: Cache cargo build
        uses: actions/cache@v4
        with:
          path: target
          key: termux-${{ matrix.target }}-${{ hashFiles('**/Cargo.lock') }}

      - name: Setup build logging
        run: |
          mkdir -p .github/build-logs
          TIMESTAMP=$(date +%Y%m%d-%H%M%S)
          BUILD_LOG=".github/build-logs/build-${{ matrix.arch }}-${TIMESTAMP}.log"
          echo "BUILD_LOG=$BUILD_LOG" >> $GITHUB_ENV
          echo "BUILD_TIMESTAMP=$TIMESTAMP" >> $GITHUB_ENV
          
          # Create log header
          cat > $BUILD_LOG << 'EOFLOG'
          â•”â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•—
          â•‘          InjectTools Termux Build Log                        â•‘
          â•šâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
          EOFLOG
          
          cat >> $BUILD_LOG << EOF
          
          Build Information:
          ------------------
          Target: ${{ matrix.target }}
          Architecture: ${{ matrix.arch }}
          Android API: ${{ matrix.api }}
          Runner OS: ubuntu-latest
          Rust Version: $(rustc --version)
          Cargo Version: $(cargo --version)
          
          Triggered by: ${{ github.event_name }}
          Commit SHA: ${{ github.sha }}
          Ref: ${{ github.ref }}
          Actor: ${{ github.actor }}
          
          Started at: $(date -u +'%Y-%m-%d %H:%M:%S UTC')
          
          â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
          
          EOF

      - name: Download & Setup Android NDK
        run: |
          {
            echo "[$(date +'%H:%M:%S')] ðŸ“¦ Downloading Android NDK r26d..."
            
            if ! wget -q https://dl.google.com/android/repository/android-ndk-r26d-linux.zip; then
              echo "[$(date +'%H:%M:%S')] âŒ ERROR: Failed to download NDK"
              exit 1
            fi
            
            echo "[$(date +'%H:%M:%S')] ðŸ“‚ Extracting NDK..."
            if ! unzip -q android-ndk-r26d-linux.zip; then
              echo "[$(date +'%H:%M:%S')] âŒ ERROR: Failed to extract NDK"
              exit 1
            fi
            
            echo "ANDROID_NDK_HOME=$PWD/android-ndk-r26d" >> $GITHUB_ENV
            echo "[$(date +'%H:%M:%S')] âœ… NDK installed at: $PWD/android-ndk-r26d"
            
          } 2>&1 | tee -a $BUILD_LOG

      - name: Setup Android Build Environment
        run: |
          {
            echo "[$(date +'%H:%M:%S')] âš™ï¸ Configuring Android build environment..."
            
            NDK_BIN="$ANDROID_NDK_HOME/toolchains/llvm/prebuilt/linux-x86_64/bin"
            
            # Set environment variables for cc-rs crate
            echo "CC_aarch64_linux_android=${NDK_BIN}/aarch64-linux-android${{ matrix.api }}-clang" >> $GITHUB_ENV
            echo "CXX_aarch64_linux_android=${NDK_BIN}/aarch64-linux-android${{ matrix.api }}-clang++" >> $GITHUB_ENV
            echo "AR_aarch64_linux_android=${NDK_BIN}/llvm-ar" >> $GITHUB_ENV
            
            echo "CC_armv7_linux_androideabi=${NDK_BIN}/armv7a-linux-androideabi${{ matrix.api }}-clang" >> $GITHUB_ENV
            echo "CXX_armv7_linux_androideabi=${NDK_BIN}/armv7a-linux-androideabi${{ matrix.api }}-clang++" >> $GITHUB_ENV
            echo "AR_armv7_linux_androideabi=${NDK_BIN}/llvm-ar" >> $GITHUB_ENV
            
            # Cargo linker configuration
            echo "CARGO_TARGET_AARCH64_LINUX_ANDROID_LINKER=${NDK_BIN}/aarch64-linux-android${{ matrix.api }}-clang" >> $GITHUB_ENV
            echo "CARGO_TARGET_ARMV7_LINUX_ANDROIDEABI_LINKER=${NDK_BIN}/armv7a-linux-androideabi${{ matrix.api }}-clang" >> $GITHUB_ENV
            
            echo "[$(date +'%H:%M:%S')] âœ… Environment variables configured"
            
          } 2>&1 | tee -a $BUILD_LOG

      - name: Build release binary
        id: build
        continue-on-error: true
        run: |
          {
            echo "[$(date +'%H:%M:%S')] ðŸ”¨ Starting cargo build for ${{ matrix.target }}..."
            echo ""
            
            if cargo build --release --target ${{ matrix.target }} 2>&1; then
              echo ""
              echo "[$(date +'%H:%M:%S')] âœ… Build completed successfully"
              echo "BUILD_STATUS=success" >> $GITHUB_OUTPUT
            else
              BUILD_EXIT_CODE=$?
              echo ""
              echo "[$(date +'%H:%M:%S')] âŒ Build failed with exit code: $BUILD_EXIT_CODE"
              echo "BUILD_STATUS=failed" >> $GITHUB_OUTPUT
              exit 1
            fi
            
            echo ""
            echo "Build artifacts:"
            ls -lh target/${{ matrix.target }}/release/ | grep injecttools || echo "Binary not found!"
            
          } 2>&1 | tee -a $BUILD_LOG

      - name: Strip binary
        if: steps.build.outputs.BUILD_STATUS == 'success'
        run: |
          {
            echo "[$(date +'%H:%M:%S')] âœ‚ï¸ Stripping debug symbols..."
            
            SIZE_BEFORE=$(stat -c%s target/${{ matrix.target }}/release/injecttools)
            echo "Binary size before strip: $(numfmt --to=iec-i --suffix=B $SIZE_BEFORE)"
            
            $ANDROID_NDK_HOME/toolchains/llvm/prebuilt/linux-x86_64/bin/llvm-strip \
              target/${{ matrix.target }}/release/injecttools
            
            SIZE_AFTER=$(stat -c%s target/${{ matrix.target }}/release/injecttools)
            echo "Binary size after strip: $(numfmt --to=iec-i --suffix=B $SIZE_AFTER)"
            
            SAVED=$((SIZE_BEFORE - SIZE_AFTER))
            echo "Space saved: $(numfmt --to=iec-i --suffix=B $SAVED)"
            
          } 2>&1 | tee -a $BUILD_LOG

      - name: Test binary
        if: steps.build.outputs.BUILD_STATUS == 'success'
        run: |
          {
            echo "[$(date +'%H:%M:%S')] ðŸ§ª Testing binary validity..."
            echo ""
            file target/${{ matrix.target }}/release/injecttools
            echo ""
            ls -lh target/${{ matrix.target }}/release/injecttools
            echo ""
            echo "[$(date +'%H:%M:%S')] âœ… Binary is valid"
            
          } 2>&1 | tee -a $BUILD_LOG

      - name: Compress binary
        if: steps.build.outputs.BUILD_STATUS == 'success'
        run: |
          {
            echo "[$(date +'%H:%M:%S')] ðŸ“¦ Compressing binary..."
            
            cd target/${{ matrix.target }}/release
            tar czf ../../../${{ matrix.asset_name }}.tar.gz injecttools
            cd ../../..
            
            SIZE=$(stat -c%s ${{ matrix.asset_name }}.tar.gz)
            echo "Compressed size: $(numfmt --to=iec-i --suffix=B $SIZE)"
            ls -lh ${{ matrix.asset_name }}.tar.gz
            
          } 2>&1 | tee -a $BUILD_LOG

      - name: Generate SHA256 checksum
        if: steps.build.outputs.BUILD_STATUS == 'success'
        run: |
          {
            echo "[$(date +'%H:%M:%S')] ðŸ” Generating SHA256 checksum..."
            sha256sum ${{ matrix.asset_name }}.tar.gz > ${{ matrix.asset_name }}.tar.gz.sha256
            cat ${{ matrix.asset_name }}.tar.gz.sha256
            
          } 2>&1 | tee -a $BUILD_LOG

      - name: Finalize build log
        if: always()
        run: |
          {
            echo ""
            echo "â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"
            echo ""
            echo "Build Summary:"
            echo "--------------"
            echo "Status: ${{ steps.build.outputs.BUILD_STATUS || 'failed' }}"
            echo "Finished at: $(date -u +'%Y-%m-%d %H:%M:%S UTC')"
            echo "Duration: $SECONDS seconds"
            echo ""
            
            if [ "${{ steps.build.outputs.BUILD_STATUS }}" = "success" ]; then
              echo "âœ… Build completed successfully!"
              echo ""
              echo "Artifacts:"
              echo "  - ${{ matrix.asset_name }}.tar.gz"
              echo "  - ${{ matrix.asset_name }}.tar.gz.sha256"
            else
              echo "âŒ Build failed. Check logs above for errors."
              echo ""
              echo "Common issues:"
              echo "  - Dependency compilation errors"
              echo "  - Linker errors (check NDK configuration)"
              echo "  - Out of memory"
            fi
            
            echo ""
            echo "â•”â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•—"
            echo "â•‘                    End of Build Log                          â•‘"
            echo "â•šâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"
            
          } 2>&1 | tee -a $BUILD_LOG

      - name: Push build log to repository
        if: always()
        run: |
          git config --global user.name "github-actions[bot]"
          git config --global user.email "github-actions[bot]@users.noreply.github.com"
          
          # Rename log with status prefix
          STATUS="${{ steps.build.outputs.BUILD_STATUS || 'failed' }}"
          FINAL_LOG=".github/build-logs/${STATUS}-${{ matrix.arch }}-${BUILD_TIMESTAMP}.log"
          mv $BUILD_LOG $FINAL_LOG
          
          # Keep only last 10 logs per architecture
          cd .github/build-logs
          ls -t *-${{ matrix.arch }}-*.log 2>/dev/null | tail -n +11 | xargs -r rm -f
          cd ../..
          
          # Commit and push
          git add .github/build-logs/
          
          if git diff --staged --quiet; then
            echo "No build log changes to commit"
          else
            git commit -m "ci: Add build log [$STATUS] for ${{ matrix.arch }} - ${BUILD_TIMESTAMP}"
            
            # Retry push up to 3 times
            for i in {1..3}; do
              if git push origin HEAD:main; then
                echo "âœ… Build log pushed successfully"
                break
              else
                echo "âš ï¸ Push attempt $i failed, retrying..."
                git pull --rebase origin main
                sleep 2
              fi
              
              if [ $i -eq 3 ]; then
                echo "âŒ Failed to push build log after 3 attempts"
                echo "Log will be available as artifact only"
              fi
            done
          fi

      - name: Upload build log as artifact
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: build-log-${{ matrix.arch }}-${{ env.BUILD_TIMESTAMP }}
          path: .github/build-logs/*-${{ matrix.arch }}-${{ env.BUILD_TIMESTAMP }}.log
          retention-days: 30

      - name: Upload build artifacts
        if: steps.build.outputs.BUILD_STATUS == 'success'
        uses: actions/upload-artifact@v4
        with:
          name: ${{ matrix.asset_name }}
          path: |
            ${{ matrix.asset_name }}.tar.gz
            ${{ matrix.asset_name }}.tar.gz.sha256
          retention-days: 7

      - name: Fail job if build failed
        if: steps.build.outputs.BUILD_STATUS != 'success'
        run: |
          echo "::error::Build failed for ${{ matrix.target }}"
          echo "::error::Check build log at .github/build-logs/failed-${{ matrix.arch }}-${BUILD_TIMESTAMP}.log"
          exit 1

  create-release:
    name: Create GitHub Release
    needs: build-termux
    runs-on: ubuntu-latest
    permissions:
      contents: write
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Download all artifacts
        uses: actions/download-artifact@v4
        with:
          path: artifacts

      - name: Prepare release assets
        run: |
          mkdir -p release-assets
          find artifacts -type f -name "*.tar.gz" -exec cp {} release-assets/ \;
          find artifacts -type f -name "*.sha256" -exec cp {} release-assets/ \;
          
          cd release-assets
          ls -lh
          
          echo "ðŸ“ Generating combined checksums..."
          cat *.sha256 > checksums.txt
          cat checksums.txt

      - name: Get version tag
        id: version
        run: |
          if [ "${{ github.event_name }}" == "workflow_dispatch" ]; then
            echo "version=${{ github.event.inputs.version }}" >> $GITHUB_OUTPUT
          else
            echo "version=${GITHUB_REF#refs/tags/}" >> $GITHUB_OUTPUT
          fi
          
          VERSION=$(echo "${{ github.event_name == 'workflow_dispatch' && github.event.inputs.version || github.ref }}" | sed 's|refs/tags/||')
          echo "version=$VERSION" >> $GITHUB_OUTPUT
          echo "ðŸ“Œ Release version: $VERSION"

      - name: Create GitHub Release
        uses: softprops/action-gh-release@v1
        with:
          tag_name: ${{ steps.version.outputs.version }}
          name: InjectTools ${{ steps.version.outputs.version }} (Termux)
          draft: false
          prerelease: false
          generate_release_notes: true
          body: |
            # InjectTools ${{ steps.version.outputs.version }} - Termux Edition
            
            ðŸ¤– **Bug Inject Scanner for Cloudflare Subdomains** - Optimized for Android/Termux
            
            ## ðŸ“¥ Quick Install
            
            ```bash
            curl -sSL https://raw.githubusercontent.com/hoshiyomiX/InjectTools/main/install.sh | bash
            ```
            
            ## ðŸ“¦ Manual Downloads
            
            | Device Type | Architecture | Download |
            |-------------|--------------|----------|
            | **Modern Android** (2018+) | ARM64 (aarch64) | `injecttools-termux-arm64.tar.gz` |
            | **Older Android** (2015-2018) | ARMv7 | `injecttools-termux-armv7.tar.gz` |
            
            **Check architecture:** `uname -m`
            
            ## âœ¨ Features v2.3
            
            - âš¡ Async concurrent scanning
            - ðŸ” Auto Cloudflare detection
            - ðŸ“Š Real-time progress bar
            - ðŸŒ crt.sh subdomain scanner
            - ðŸ“‹ Batch testing (manual/file)
            - ðŸ“ Results viewer & export
            - ðŸ“¡ Ping test support
            - ðŸŽ¨ Colorful TUI
            - ðŸ’¾ Config persistence
            
            ## ðŸ” Checksums
            
            ```
            $(cat release-assets/checksums.txt)
            ```
            
            ## ðŸ“ Build Logs
            
            Detailed build logs tersedia di:
            - [View Build Logs](https://github.com/hoshiyomiX/InjectTools/tree/main/.github/build-logs)
            
            ## ðŸ“– Documentation
            
            - [README.md](https://github.com/hoshiyomiX/InjectTools#readme)
            - [Termux Build Guide](https://github.com/hoshiyomiX/InjectTools/blob/main/TERMUX_BUILD.md)
            
            ---
            
            **Created by:** [@hoshiyomi_id](https://t.me/hoshiyomi_id)  
            **Build Date:** $(date -u +'%Y-%m-%d %H:%M:%S UTC')  
            
            Report issues: [GitHub Issues](https://github.com/hoshiyomiX/InjectTools/issues)
          files: |
            release-assets/*
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

      - name: Release Summary
        run: |
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "## ðŸŽ‰ Release Created Successfully!" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "**Version:** ${{ steps.version.outputs.version }}" >> $GITHUB_STEP_SUMMARY
          echo "**Targets:**" >> $GITHUB_STEP_SUMMARY
          echo "- âœ… ARM64 (aarch64)" >> $GITHUB_STEP_SUMMARY
          echo "- âœ… ARMv7" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "**Downloads:**" >> $GITHUB_STEP_SUMMARY
          echo "- ðŸ“¦ [injecttools-termux-arm64.tar.gz](https://github.com/hoshiyomiX/InjectTools/releases/download/${{ steps.version.outputs.version }}/injecttools-termux-arm64.tar.gz)" >> $GITHUB_STEP_SUMMARY
          echo "- ðŸ“¦ [injecttools-termux-armv7.tar.gz](https://github.com/hoshiyomiX/InjectTools/releases/download/${{ steps.version.outputs.version }}/injecttools-termux-armv7.tar.gz)" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "**Build Logs:**" >> $GITHUB_STEP_SUMMARY
          echo "- ðŸ“‹ [View Logs](.github/build-logs/)" >> $GITHUB_STEP_SUMMARY