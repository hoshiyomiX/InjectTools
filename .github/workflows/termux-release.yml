name: Termux Build & Release

on:
  push:
    tags:
      - 'termux-v*.*.*'
  workflow_dispatch:
    inputs:
      version:
        description: 'Release version (e.g., termux-v2.3.0)'
        required: true
        default: 'termux-v2.3.0'

env:
  CARGO_TERM_COLOR: always
  CARGO_INCREMENTAL: 0
  RUST_BACKTRACE: 1

permissions:
  contents: write

jobs:
  build-arm64:
    name: Build ARM64
    runs-on: ubuntu-latest
    
    # Serialize log commits to prevent race conditions
    concurrency:
      group: commit-logs-${{ github.ref }}
      cancel-in-progress: false
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          token: ${{ secrets.GITHUB_TOKEN }}
          fetch-depth: 0

      - name: Setup build log
        run: |
          mkdir -p build-logs
          LOG_FILE="build-logs/build-aarch64-linux-android.log"
          
          echo "Build started at $(date -u '+%Y-%m-%d %H:%M:%S UTC')" | tee $LOG_FILE
          echo "Target: aarch64-linux-android" | tee -a $LOG_FILE
          echo "Branch: ${{ github.ref_name }}" | tee -a $LOG_FILE
          echo "Commit: $(git rev-parse --short HEAD)" | tee -a $LOG_FILE
          echo "Triggered by: ${{ github.event_name }}" | tee -a $LOG_FILE
          echo "========================================" | tee -a $LOG_FILE
          
          echo "LOG_FILE=$LOG_FILE" >> $GITHUB_ENV

      - name: Install Rust toolchain
        uses: dtolnay/rust-toolchain@stable
        with:
          targets: aarch64-linux-android

      - name: Cache cargo registry
        uses: actions/cache@v4
        with:
          path: |
            ~/.cargo/registry/index
            ~/.cargo/registry/cache
            ~/.cargo/git/db
          key: cargo-registry-${{ hashFiles('**/Cargo.lock') }}
          restore-keys: cargo-registry-

      - name: Cache target (ARM64)
        uses: actions/cache@v4
        with:
          path: target/aarch64-linux-android
          key: target-arm64-${{ hashFiles('**/Cargo.lock') }}-${{ hashFiles('src/**/*.rs') }}
          restore-keys: target-arm64-

      - name: Download Android NDK
        run: |
          echo "ğŸ“¥ Downloading Android NDK r26d..." | tee -a $LOG_FILE
          wget -q https://dl.google.com/android/repository/android-ndk-r26d-linux.zip
          
          echo "ğŸ“¦ Extracting NDK..." | tee -a $LOG_FILE
          unzip -q android-ndk-r26d-linux.zip
          
          echo "ANDROID_NDK_HOME=$PWD/android-ndk-r26d" >> $GITHUB_ENV
          echo "âœ… NDK ready" | tee -a $LOG_FILE

      - name: Configure toolchain
        run: |
          NDK_BIN="$ANDROID_NDK_HOME/toolchains/llvm/prebuilt/linux-x86_64/bin"
          
          echo "CC_aarch64_linux_android=${NDK_BIN}/aarch64-linux-android30-clang" >> $GITHUB_ENV
          echo "AR_aarch64_linux_android=${NDK_BIN}/llvm-ar" >> $GITHUB_ENV
          echo "CARGO_TARGET_AARCH64_LINUX_ANDROID_LINKER=${NDK_BIN}/aarch64-linux-android30-clang" >> $GITHUB_ENV
          
          echo "ğŸ”§ Toolchain configured" | tee -a $LOG_FILE

      - name: Force clean build
        run: |
          echo "ğŸ§¹ Cleaning build artifacts..." | tee -a $LOG_FILE
          cargo clean 2>&1 | tee -a $LOG_FILE
          rm -rf target/
          echo "âœ… Clean complete" | tee -a $LOG_FILE

      - name: Build binary
        id: build
        continue-on-error: true
        run: |
          set -o pipefail
          
          echo "ğŸ”¨ Building from source..." | tee -a $LOG_FILE
          echo "========================================" | tee -a $LOG_FILE
          
          # Build context
          CARGO_VERSION=$(grep '^version' Cargo.toml | sed 's/version = "\(.*\)"/\1/')
          SOURCES_HASH=$(find src -type f -name '*.rs' -exec sha256sum {} \; | sha256sum | cut -d' ' -f1)
          
          echo "ğŸ“‹ Build Context:" | tee -a $LOG_FILE
          echo "Cargo version: $CARGO_VERSION" | tee -a $LOG_FILE
          echo "Sources hash: $SOURCES_HASH" | tee -a $LOG_FILE
          echo "========================================" | tee -a $LOG_FILE
          
          BUILD_START=$(date +%s)
          
          if cargo build --release --target aarch64-linux-android 2>&1 | tee -a $LOG_FILE; then
            BUILD_END=$(date +%s)
            BUILD_DURATION=$((BUILD_END - BUILD_START))
            
            echo "========================================" | tee -a $LOG_FILE
            echo "âœ… Build completed in ${BUILD_DURATION}s" | tee -a $LOG_FILE
            
            # Verify binary
            if [ ! -f target/aarch64-linux-android/release/injecttools ]; then
              echo "âŒ Binary not found!" | tee -a $LOG_FILE
              exit 1
            fi
            
            # Check freshness
            CURRENT_TIME=$(date +%s)
            BINARY_TIME=$(stat -c %Y target/aarch64-linux-android/release/injecttools)
            BINARY_AGE=$((CURRENT_TIME - BINARY_TIME))
            
            echo "ğŸ” Binary age: ${BINARY_AGE}s" | tee -a $LOG_FILE
            
            if [ $BINARY_AGE -gt 300 ]; then
              echo "âŒ Binary is stale (${BINARY_AGE}s > 300s)" | tee -a $LOG_FILE
              exit 1
            fi
            
            ls -lh target/aarch64-linux-android/release/injecttools | tee -a $LOG_FILE
          else
            echo "âŒ Build failed" | tee -a $LOG_FILE
            exit 1
          fi

      - name: Strip binary
        if: steps.build.outcome == 'success'
        run: |
          BEFORE=$(stat -c%s target/aarch64-linux-android/release/injecttools)
          
          $ANDROID_NDK_HOME/toolchains/llvm/prebuilt/linux-x86_64/bin/llvm-strip \
            target/aarch64-linux-android/release/injecttools
          
          AFTER=$(stat -c%s target/aarch64-linux-android/release/injecttools)
          SAVED=$((BEFORE - AFTER))
          
          echo "ğŸ“¦ Stripped: $(numfmt --to=iec-i --suffix=B $BEFORE) â†’ $(numfmt --to=iec-i --suffix=B $AFTER) (saved $(numfmt --to=iec-i --suffix=B $SAVED))" | tee -a $LOG_FILE

      - name: Package
        if: steps.build.outcome == 'success'
        run: |
          cd target/aarch64-linux-android/release
          tar czf ../../../injecttools-termux-arm64.tar.gz injecttools
          cd ../../..
          
          sha256sum injecttools-termux-arm64.tar.gz | tee injecttools-termux-arm64.tar.gz.sha256 | tee -a $LOG_FILE

      - name: Finalize build log
        if: always()
        run: |
          echo "========================================" | tee -a $LOG_FILE
          echo "Status: ${{ steps.build.outcome }}" | tee -a $LOG_FILE
          echo "Finished: $(date -u '+%Y-%m-%d %H:%M:%S UTC')" | tee -a $LOG_FILE

      - name: Commit build log with retry
        if: always()
        run: |
          git config --local user.email "github-actions[bot]@users.noreply.github.com"
          git config --local user.name "github-actions[bot]"
          
          git add $LOG_FILE
          
          if git diff --staged --quiet; then
            echo "No changes to commit"
            exit 0
          fi
          
          git commit -m "chore: update ARM64 build log - ${{ steps.build.outcome }} [skip ci]"
          
          # Retry push with exponential backoff
          MAX_RETRIES=5
          RETRY_COUNT=0
          
          while [ $RETRY_COUNT -lt $MAX_RETRIES ]; do
            echo "ğŸ“¤ Push attempt $((RETRY_COUNT + 1))/$MAX_RETRIES..."
            
            # Fetch and rebase before push
            git fetch origin ${{ github.ref_name }}
            git rebase origin/${{ github.ref_name }} || {
              echo "âš ï¸ Rebase failed, resolving..."
              git rebase --abort
              git reset --soft HEAD~1
              git pull --rebase origin ${{ github.ref_name }}
              git add $LOG_FILE
              git commit -m "chore: update ARM64 build log - ${{ steps.build.outcome }} [skip ci]"
            }
            
            if git push origin HEAD:${{ github.ref_name }}; then
              echo "âœ… Push successful!"
              exit 0
            fi
            
            RETRY_COUNT=$((RETRY_COUNT + 1))
            WAIT_TIME=$((2 ** RETRY_COUNT))
            echo "âš ï¸ Push failed, waiting ${WAIT_TIME}s before retry..."
            sleep $WAIT_TIME
          done
          
          echo "âŒ Failed to push after $MAX_RETRIES attempts"
          exit 1

      - name: Upload artifacts
        if: steps.build.outcome == 'success'
        uses: actions/upload-artifact@v4
        with:
          name: injecttools-termux-arm64
          path: |
            injecttools-termux-arm64.tar.gz
            injecttools-termux-arm64.tar.gz.sha256

      - name: Fail job if build failed
        if: steps.build.outcome != 'success'
        run: exit 1

  build-armv7:
    name: Build ARMv7
    runs-on: ubuntu-latest
    needs: build-arm64
    
    concurrency:
      group: commit-logs-${{ github.ref }}
      cancel-in-progress: false
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          token: ${{ secrets.GITHUB_TOKEN }}
          fetch-depth: 0

      - name: Setup build log
        run: |
          mkdir -p build-logs
          LOG_FILE="build-logs/build-armv7-linux-androideabi.log"
          
          echo "Build started at $(date -u '+%Y-%m-%d %H:%M:%S UTC')" | tee $LOG_FILE
          echo "Target: armv7-linux-androideabi" | tee -a $LOG_FILE
          echo "Branch: ${{ github.ref_name }}" | tee -a $LOG_FILE
          echo "Commit: $(git rev-parse --short HEAD)" | tee -a $LOG_FILE
          echo "Triggered by: ${{ github.event_name }}" | tee -a $LOG_FILE
          echo "========================================" | tee -a $LOG_FILE
          
          echo "LOG_FILE=$LOG_FILE" >> $GITHUB_ENV

      - name: Install Rust toolchain
        uses: dtolnay/rust-toolchain@stable
        with:
          targets: armv7-linux-androideabi

      - name: Cache cargo registry
        uses: actions/cache@v4
        with:
          path: |
            ~/.cargo/registry/index
            ~/.cargo/registry/cache
            ~/.cargo/git/db
          key: cargo-registry-${{ hashFiles('**/Cargo.lock') }}
          restore-keys: cargo-registry-

      - name: Cache target (ARMv7)
        uses: actions/cache@v4
        with:
          path: target/armv7-linux-androideabi
          key: target-armv7-${{ hashFiles('**/Cargo.lock') }}-${{ hashFiles('src/**/*.rs') }}
          restore-keys: target-armv7-

      - name: Download Android NDK
        run: |
          echo "ğŸ“¥ Downloading Android NDK r26d..." | tee -a $LOG_FILE
          wget -q https://dl.google.com/android/repository/android-ndk-r26d-linux.zip
          
          echo "ğŸ“¦ Extracting NDK..." | tee -a $LOG_FILE
          unzip -q android-ndk-r26d-linux.zip
          
          echo "ANDROID_NDK_HOME=$PWD/android-ndk-r26d" >> $GITHUB_ENV
          echo "âœ… NDK ready" | tee -a $LOG_FILE

      - name: Configure toolchain
        run: |
          NDK_BIN="$ANDROID_NDK_HOME/toolchains/llvm/prebuilt/linux-x86_64/bin"
          
          echo "CC_armv7_linux_androideabi=${NDK_BIN}/armv7a-linux-androideabi30-clang" >> $GITHUB_ENV
          echo "AR_armv7_linux_androideabi=${NDK_BIN}/llvm-ar" >> $GITHUB_ENV
          echo "CARGO_TARGET_ARMV7_LINUX_ANDROIDEABI_LINKER=${NDK_BIN}/armv7a-linux-androideabi30-clang" >> $GITHUB_ENV
          
          echo "ğŸ”§ Toolchain configured" | tee -a $LOG_FILE

      - name: Force clean build
        run: |
          echo "ğŸ§¹ Cleaning build artifacts..." | tee -a $LOG_FILE
          cargo clean 2>&1 | tee -a $LOG_FILE
          rm -rf target/
          echo "âœ… Clean complete" | tee -a $LOG_FILE

      - name: Build binary
        id: build
        continue-on-error: true
        run: |
          set -o pipefail
          
          echo "ğŸ”¨ Building from source..." | tee -a $LOG_FILE
          echo "========================================" | tee -a $LOG_FILE
          
          # Build context
          CARGO_VERSION=$(grep '^version' Cargo.toml | sed 's/version = "\(.*\)"/\1/')
          SOURCES_HASH=$(find src -type f -name '*.rs' -exec sha256sum {} \; | sha256sum | cut -d' ' -f1)
          
          echo "ğŸ“‹ Build Context:" | tee -a $LOG_FILE
          echo "Cargo version: $CARGO_VERSION" | tee -a $LOG_FILE
          echo "Sources hash: $SOURCES_HASH" | tee -a $LOG_FILE
          echo "========================================" | tee -a $LOG_FILE
          
          BUILD_START=$(date +%s)
          
          if cargo build --release --target armv7-linux-androideabi 2>&1 | tee -a $LOG_FILE; then
            BUILD_END=$(date +%s)
            BUILD_DURATION=$((BUILD_END - BUILD_START))
            
            echo "========================================" | tee -a $LOG_FILE
            echo "âœ… Build completed in ${BUILD_DURATION}s" | tee -a $LOG_FILE
            
            # Verify binary
            if [ ! -f target/armv7-linux-androideabi/release/injecttools ]; then
              echo "âŒ Binary not found!" | tee -a $LOG_FILE
              exit 1
            fi
            
            # Check freshness
            CURRENT_TIME=$(date +%s)
            BINARY_TIME=$(stat -c %Y target/armv7-linux-androideabi/release/injecttools)
            BINARY_AGE=$((CURRENT_TIME - BINARY_TIME))
            
            echo "ğŸ” Binary age: ${BINARY_AGE}s" | tee -a $LOG_FILE
            
            if [ $BINARY_AGE -gt 300 ]; then
              echo "âŒ Binary is stale (${BINARY_AGE}s > 300s)" | tee -a $LOG_FILE
              exit 1
            fi
            
            ls -lh target/armv7-linux-androideabi/release/injecttools | tee -a $LOG_FILE
          else
            echo "âŒ Build failed" | tee -a $LOG_FILE
            exit 1
          fi

      - name: Strip binary
        if: steps.build.outcome == 'success'
        run: |
          BEFORE=$(stat -c%s target/armv7-linux-androideabi/release/injecttools)
          
          $ANDROID_NDK_HOME/toolchains/llvm/prebuilt/linux-x86_64/bin/llvm-strip \
            target/armv7-linux-androideabi/release/injecttools
          
          AFTER=$(stat -c%s target/armv7-linux-androideabi/release/injecttools)
          SAVED=$((BEFORE - AFTER))
          
          echo "ğŸ“¦ Stripped: $(numfmt --to=iec-i --suffix=B $BEFORE) â†’ $(numfmt --to=iec-i --suffix=B $AFTER) (saved $(numfmt --to=iec-i --suffix=B $SAVED))" | tee -a $LOG_FILE

      - name: Package
        if: steps.build.outcome == 'success'
        run: |
          cd target/armv7-linux-androideabi/release
          tar czf ../../../injecttools-termux-armv7.tar.gz injecttools
          cd ../../..
          
          sha256sum injecttools-termux-armv7.tar.gz | tee injecttools-termux-armv7.tar.gz.sha256 | tee -a $LOG_FILE

      - name: Finalize build log
        if: always()
        run: |
          echo "========================================" | tee -a $LOG_FILE
          echo "Status: ${{ steps.build.outcome }}" | tee -a $LOG_FILE
          echo "Finished: $(date -u '+%Y-%m-%d %H:%M:%S UTC')" | tee -a $LOG_FILE

      - name: Commit build log with retry
        if: always()
        run: |
          git config --local user.email "github-actions[bot]@users.noreply.github.com"
          git config --local user.name "github-actions[bot]"
          
          git add $LOG_FILE
          
          if git diff --staged --quiet; then
            echo "No changes to commit"
            exit 0
          fi
          
          git commit -m "chore: update ARMv7 build log - ${{ steps.build.outcome }} [skip ci]"
          
          # Retry push with exponential backoff
          MAX_RETRIES=5
          RETRY_COUNT=0
          
          while [ $RETRY_COUNT -lt $MAX_RETRIES ]; do
            echo "ğŸ“¤ Push attempt $((RETRY_COUNT + 1))/$MAX_RETRIES..."
            
            # Fetch and rebase before push
            git fetch origin ${{ github.ref_name }}
            git rebase origin/${{ github.ref_name }} || {
              echo "âš ï¸ Rebase failed, resolving..."
              git rebase --abort
              git reset --soft HEAD~1
              git pull --rebase origin ${{ github.ref_name }}
              git add $LOG_FILE
              git commit -m "chore: update ARMv7 build log - ${{ steps.build.outcome }} [skip ci]"
            }
            
            if git push origin HEAD:${{ github.ref_name }}; then
              echo "âœ… Push successful!"
              exit 0
            fi
            
            RETRY_COUNT=$((RETRY_COUNT + 1))
            WAIT_TIME=$((2 ** RETRY_COUNT))
            echo "âš ï¸ Push failed, waiting ${WAIT_TIME}s before retry..."
            sleep $WAIT_TIME
          done
          
          echo "âŒ Failed to push after $MAX_RETRIES attempts"
          exit 1

      - name: Upload artifacts
        if: steps.build.outcome == 'success'
        uses: actions/upload-artifact@v4
        with:
          name: injecttools-termux-armv7
          path: |
            injecttools-termux-armv7.tar.gz
            injecttools-termux-armv7.tar.gz.sha256

      - name: Fail job if build failed
        if: steps.build.outcome != 'success'
        run: exit 1

  create-release:
    name: Create Release
    needs: [build-arm64, build-armv7]
    runs-on: ubuntu-latest
    permissions:
      contents: write
      
    steps:
      - uses: actions/checkout@v4
      
      - name: Download artifacts
        uses: actions/download-artifact@v4
        with:
          path: artifacts
      
      - name: Prepare release
        run: |
          mkdir -p release-assets
          find artifacts -name "*.tar.gz" -exec cp {} release-assets/ \;
          find artifacts -name "*.sha256" -exec cp {} release-assets/ \;
          
          cd release-assets
          cat *.sha256 > checksums.txt
          
          echo "ğŸ“¦ Release Assets:"
          ls -lh
      
      - name: Get version
        id: version
        run: |
          if [ "${{ github.event_name }}" = "workflow_dispatch" ]; then
            echo "version=${{ github.event.inputs.version }}" >> $GITHUB_OUTPUT
          else
            echo "version=${GITHUB_REF#refs/tags/}" >> $GITHUB_OUTPUT
          fi
      
      - name: Get Cargo version
        id: cargo_version
        run: |
          CARGO_VERSION=$(grep '^version' Cargo.toml | sed 's/version = "\(.*\)"/\1/')
          echo "cargo_version=$CARGO_VERSION" >> $GITHUB_OUTPUT
      
      - name: Create release
        uses: softprops/action-gh-release@v1
        with:
          tag_name: ${{ steps.version.outputs.version }}
          name: InjectTools v${{ steps.cargo_version.outputs.cargo_version }}
          body: |
            # InjectTools v${{ steps.cargo_version.outputs.cargo_version }} - Termux Edition
            
            ğŸ¤– **Bug Inject Scanner for Cloudflare Subdomains** - High-performance Rust implementation
            
            ## âœ¨ Quick Install
            
            ```bash
            curl -sSL https://raw.githubusercontent.com/hoshiyomiX/InjectTools/main/install.sh | bash
            ```
            
            ## ğŸ“¦ Manual Install
            
            **Check architecture:**
            ```bash
            uname -m
            # aarch64 = ARM64, armv7l = ARMv7
            ```
            
            **ARM64:**
            ```bash
            wget https://github.com/hoshiyomiX/InjectTools/releases/download/${{ steps.version.outputs.version }}/injecttools-termux-arm64.tar.gz
            tar xzf injecttools-termux-arm64.tar.gz && mv injecttools $PREFIX/bin/ && chmod +x $PREFIX/bin/injecttools
            ```
            
            **ARMv7:**
            ```bash
            wget https://github.com/hoshiyomiX/InjectTools/releases/download/${{ steps.version.outputs.version }}/injecttools-termux-armv7.tar.gz
            tar xzf injecttools-termux-armv7.tar.gz && mv injecttools $PREFIX/bin/ && chmod +x $PREFIX/bin/injecttools
            ```
            
            ## ğŸš€ Features v${{ steps.cargo_version.outputs.cargo_version }}
            
            - âš¡ Async scanning with concurrency control
            - ğŸŒ crt.sh certificate transparency integration
            - ğŸ“¦ Batch testing with progress tracking
            - ğŸ“„ Export/view results in organized format
            - â˜ï¸ Cloudflare IP detection & validation
            - ğŸ”’ SSL/TLS certificate verification
            - â¹ï¸ Graceful Ctrl+C handling
            - ğŸ¯ Multi-threaded DNS resolution
            
            ## ğŸ” Checksums
            
            ```
            $(cat release-assets/checksums.txt)
            ```
            
            ## ğŸ“ Build Info
            
            - **Branch:** ${{ github.ref_name }}
            - **Commit:** ${{ github.sha }}
            - **Built:** $(date -u '+%Y-%m-%d %H:%M:%S UTC')
            
            ---
            
            **By:** [@hoshiyomi_id](https://t.me/hoshiyomi_id) | **License:** MIT
          files: release-assets/*
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
