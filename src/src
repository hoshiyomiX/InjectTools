#!/bin/bash

# InjectTools v2.3
# Bug Inject Scanner for Cloudflare Subdomains
# Created by: t.me/hoshiyomi_id

# Colors
RED='\033[0;31m'
GREEN='\033[0;32m'
YELLOW='\033[1;33m'
BLUE='\033[0;34m'
CYAN='\033[0;36m'
MAGENTA='\033[0;35m'
WHITE='\033[1;37m'
BOLD='\033[1m'
NC='\033[0m'

# Directories
BASE_DIR="/sdcard/InjectTools"
CONFIG_FILE="$BASE_DIR/config.txt"
CACHE_DIR="$BASE_DIR/cache"
RESULTS_DIR="$BASE_DIR/results"
SCAN_CANCELLED=false

# Default values
TARGET_HOST=""
TIMEOUT=10

# Create directory structure
mkdir -p "$BASE_DIR"
mkdir -p "$CACHE_DIR"
mkdir -p "$RESULTS_DIR"

# Check and install dependencies
check_dependencies() {
  local MISSING=()
  
  if ! command -v curl &> /dev/null; then
    MISSING+=("curl")
  fi
  
  if ! command -v dig &> /dev/null; then
    if ! command -v nslookup &> /dev/null; then
      MISSING+=("dnsutils")
    fi
  fi
  
  if [ ${#MISSING[@]} -gt 0 ]; then
    clear
    echo -e "${YELLOW}â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”${NC}"
    echo -e "${WHITE}${BOLD}   Dependency Check${NC}"
    echo -e "${YELLOW}â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”${NC}"
    echo ""
    echo -e "${RED}${BOLD}Beberapa package belum terinstall:${NC}"
    echo ""
    
    for pkg in "${MISSING[@]}"; do
      echo -e "  ${RED}âœ—${NC} ${WHITE}$pkg${NC}"
    done
    
    echo ""
    echo -e "${BLUE}Package ini diperlukan untuk menjalankan tool.${NC}"
    echo ""
    echo -e "${WHITE}Install sekarang? (y/n)${NC}"
    read -p "> " INSTALL_CHOICE
    
    if [[ "$INSTALL_CHOICE" =~ ^[Yy]$ ]]; then
      echo ""
      echo -e "${CYAN}ğŸ“¦ Installing packages...${NC}"
      echo ""
      
      for pkg in "${MISSING[@]}"; do
        echo -e "${YELLOW}Installing $pkg...${NC}"
        if pkg install -y $pkg; then
          echo -e "${GREEN}âœ“ $pkg installed${NC}"
        else
          echo -e "${RED}âœ— Failed to install $pkg${NC}"
          echo ""
          echo -e "${YELLOW}Install manual dengan:${NC}"
          echo -e "${WHITE}pkg install $pkg${NC}"
          echo ""
          read -p "Tekan Enter untuk exit..."
          exit 1
        fi
      done
      
      echo ""
      echo -e "${GREEN}${BOLD}âœ… Semua package berhasil diinstall!${NC}"
      echo ""
      sleep 2
    else
      echo ""
      echo -e "${YELLOW}Tool butuh packages untuk berjalan.${NC}"
      echo -e "${WHITE}Install manual dengan:${NC}"
      echo ""
      for pkg in "${MISSING[@]}"; do
        echo -e "  ${CYAN}pkg install $pkg${NC}"
      done
      echo ""
      read -p "Tekan Enter untuk exit..."
      exit 1
    fi
  fi
}

# Get terminal width and center text
center_text() {
  local text="$1"
  local width=$(tput cols 2>/dev/null || echo 60)
  local len=${#text}
  local padding=$(( (width - len) / 2 ))
  
  [ $padding -gt 0 ] && printf "%${padding}s" ""
  echo "$text"
}

# Print centered header
print_header() {
  local title="$1"
  local width=$(tput cols 2>/dev/null || echo 60)
  
  printf "${CYAN}"
  printf 'â•%.0s' $(seq 1 $width)
  printf "${NC}\n"
  
  echo -e "${WHITE}$(center_text "$title")${NC}"
  
  printf "${CYAN}"
  printf 'â•%.0s' $(seq 1 $width)
  printf "${NC}\n"
}

# Load config
load_config() {
  if [ -f "$CONFIG_FILE" ]; then
    source "$CONFIG_FILE"
    return 0
  fi
  return 1
}

# Save config
save_config() {
  cat > "$CONFIG_FILE" << EOF
# InjectTools Configuration
TARGET_HOST="$TARGET_HOST"
TIMEOUT=$TIMEOUT
EOF
  echo -e "${GREEN}âœ… Config tersimpan di: $CONFIG_FILE${NC}"
}

# First time setup
first_time_setup() {
  clear
  print_header "SETUP AWAL"
  echo ""
  echo -e "${WHITE}Selamat datang di InjectTools!${NC}"
  echo -e "${CYAN}Created by: t.me/hoshiyomi_id${NC}"
  echo ""
  echo -e "${BLUE}Yuk setup config dulu.${NC}"
  echo ""
  
  # Setup Target Host
  echo -e "${CYAN}â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”${NC}"
  echo -e "${WHITE}${BOLD}Setup Target Host${NC}"
  echo -e "${CYAN}â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”${NC}"
  echo ""
  echo -e "${BLUE}Ini domain tunnel/proxy kamu yang akan dipakai bug inject.${NC}"
  echo -e "${YELLOW}Contoh: your-tunnel.com, proxy.example.com${NC}"
  echo ""
  echo -e "${WHITE}Masukkan target host:${NC}"
  read -p "> " TARGET_HOST
  
  while [ -z "$TARGET_HOST" ]; do
    echo -e "${RED}Host gak boleh kosong!${NC}"
    read -p "> " TARGET_HOST
  done
  
  echo -e "${GREEN}âœ“ Target host: $TARGET_HOST${NC}"
  echo ""
  sleep 1
  
  # Save configuration
  echo ""
  echo -e "${CYAN}â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”${NC}"
  echo -e "${WHITE}${BOLD}Setup Selesai!${NC}"
  echo -e "${CYAN}â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”${NC}"
  echo ""
  echo -e "${BLUE}Config kamu:${NC}"
  echo -e "  ${WHITE}Target Host:${NC} ${GREEN}$TARGET_HOST${NC}"
  echo ""
  echo -e "${BLUE}Data disimpan di:${NC} ${CYAN}$BASE_DIR${NC}"
  echo ""
  
  save_config
  
  echo ""
  echo -e "${BLUE}Config bisa diubah kapan saja dari Menu 6 (Settings).${NC}"
  echo ""
  read -p "Tekan Enter untuk lanjut..."
}

# Check if Cloudflare
is_cloudflare() {
  local IP=$1
  [[ "$IP" =~ ^104\.(1[6-9]|2[0-9]|3[0-1])\. ]] || \
  [[ "$IP" =~ ^172\.(6[4-9]|7[0-1])\. ]] || \
  [[ "$IP" =~ ^173\.245\. ]] || \
  [[ "$IP" =~ ^162\.15[89]\. ]] || \
  [[ "$IP" =~ ^141\.101\. ]]
}

# Resolve domain to IP (with fallback)
resolve_to_ip() {
  local DOMAIN=$1
  local IP=""
  
  if command -v dig &> /dev/null; then
    IP=$(dig +short $DOMAIN 2>/dev/null | grep -E '^[0-9]+\.[0-9]+\.[0-9]+\.[0-9]+$' | head -n1)
  fi
  
  if [ -z "$IP" ] && command -v nslookup &> /dev/null; then
    IP=$(nslookup $DOMAIN 2>/dev/null | awk '/^Address: / { print $2 }' | grep -E '^[0-9]+\.[0-9]+\.[0-9]+\.[0-9]+$' | head -n1)
  fi
  
  echo "$IP"
}

# Ping test
ping_test() {
  local HOST=$1
  local PING_TIME=$(ping -c 1 -W 2 $HOST 2>/dev/null | grep 'time=' | awk -F'time=' '{print $2}' | awk '{print $1}')
  echo "$PING_TIME"
}

# Show warning before test
show_test_warning() {
  local width=$(tput cols 2>/dev/null || echo 60)
  
  echo ""
  printf "${YELLOW}"
  printf 'âš ï¸ %.0s' $(seq 1 $((width / 4)))
  printf "${NC}\n"
  
  echo -e "${YELLOW}${BOLD}                    PERINGATAN PENTING${NC}"
  
  printf "${YELLOW}"
  printf 'âš ï¸ %.0s' $(seq 1 $((width / 4)))
  printf "${NC}\n"
  
  echo ""
  echo -e "${WHITE}Biar hasil test akurat, pastikan:${NC}"
  echo ""
  echo -e "  ${RED}âœ—${NC} ${WHITE}Jangan pake kuota internet reguler${NC}"
  echo -e "  ${RED}âœ—${NC} ${WHITE}Jangan pake WiFi${NC}"
  echo -e "  ${RED}âœ—${NC} ${WHITE}Jangan pake aplikasi VPN inject${NC}"
  echo ""
  echo -e "${GREEN}${BOLD}Pake koneksi data seluler biasa aja (tanpa VPN)${NC}"
  echo ""
  
  printf "${YELLOW}"
  printf 'âš ï¸ %.0s' $(seq 1 $((width / 4)))
  printf "${NC}\n"
  echo ""
}

# View exported results
view_exported_results() {
  clear
  print_header "Hasil Scan Tersimpan"
  echo ""
  
  if [ ! -d "$RESULTS_DIR" ] || [ -z "$(ls -A $RESULTS_DIR/*.txt 2>/dev/null)" ]; then
    echo -e "${YELLOW}Belum ada hasil scan tersimpan.${NC}"
    echo ""
    read -p "Tekan Enter untuk kembali..."
    return
  fi
  
  echo -e "${WHITE}${BOLD}Daftar hasil scan:${NC}"
  echo ""
  
  local COUNT=1
  declare -A FILE_MAP
  
  for file in "$RESULTS_DIR"/*.txt; do
    if [ -f "$file" ]; then
      FILENAME=$(basename "$file")
      FILESIZE=$(du -h "$file" | cut -f1)
      FILETIME=$(stat -c %y "$file" 2>/dev/null || stat -f "%Sm" "$file" 2>/dev/null | cut -d' ' -f1-2)
      
      echo -e "  ${WHITE}$COUNT.${NC} ${GREEN}$FILENAME${NC}"
      echo -e "     ${CYAN}Size: $FILESIZE | Modified: $FILETIME${NC}"
      echo ""
      
      FILE_MAP[$COUNT]="$file"
      ((COUNT++))
    fi
  done
  
  if [ $COUNT -eq 1 ]; then
    echo -e "${YELLOW}Gak ada file ditemukan.${NC}"
    echo ""
    read -p "Tekan Enter untuk kembali..."
    return
  fi
  
  echo -e "${CYAN}â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”${NC}"
  echo ""
  echo -e "${WHITE}Pilih aksi:${NC}"
  echo ""
  echo -e "  ${WHITE}V [nomor]${NC} - Lihat isi file"
  echo -e "  ${WHITE}D [nomor]${NC} - Hapus file"
  echo -e "  ${WHITE}A${NC}         - Hapus semua"
  echo -e "  ${WHITE}0${NC}         - Kembali"
  echo ""
  read -p "> " ACTION
  
  case ${ACTION:0:1} in
    [Vv])
      NUM=${ACTION:2}
      if [ -n "${FILE_MAP[$NUM]}" ]; then
        clear
        print_header "Isi File"
        echo ""
        cat "${FILE_MAP[$NUM]}"
        echo ""
        read -p "Tekan Enter untuk kembali..."
        view_exported_results
      else
        echo -e "${RED}File gak ditemukan!${NC}"
        sleep 1
        view_exported_results
      fi
      ;;
      
    [Dd])
      NUM=${ACTION:2}
      if [ -n "${FILE_MAP[$NUM]}" ]; then
        FNAME=$(basename "${FILE_MAP[$NUM]}")
        echo -e "${YELLOW}Hapus file: ${WHITE}$FNAME${YELLOW}? (y/n)${NC}"
        read -p "> " CONFIRM
        if [[ "$CONFIRM" =~ ^[Yy]$ ]]; then
          rm -f "${FILE_MAP[$NUM]}"
          echo -e "${GREEN}âœ… File dihapus${NC}"
          sleep 1
        fi
        view_exported_results
      else
        echo -e "${RED}File gak ditemukan!${NC}"
        sleep 1
        view_exported_results
      fi
      ;;
      
    [Aa])
      echo -e "${RED}${BOLD}Hapus SEMUA file? (y/n):${NC}"
      read -p "> " CONFIRM
      if [[ "$CONFIRM" =~ ^[Yy]$ ]]; then
        rm -f "$RESULTS_DIR"/*.txt
        echo -e "${GREEN}âœ… Semua file dihapus${NC}"
        sleep 2
      fi
      ;;
      
    0)
      return
      ;;
      
    *)
      echo -e "${RED}Pilihan gak valid!${NC}"
      sleep 1
      view_exported_results
      ;;
  esac
}

# Test target host status
test_target_host() {
  clear
  print_header "Test Target Host"
  echo ""
  
  echo -e "${BLUE}Target Host:${NC} ${GREEN}$TARGET_HOST${NC}"
  echo ""
  
  echo -e "${CYAN}ğŸ” Checking status...${NC}"
  echo ""
  
  # DNS Resolution
  echo -e "${WHITE}1. DNS Resolution:${NC}"
  IP=$(resolve_to_ip "$TARGET_HOST")
  
  if [ -z "$IP" ]; then
    echo -e "   ${RED}âŒ Gagal - IP gak ditemukan${NC}"
    echo ""
    echo -e "${RED}${BOLD}Target host DOWN atau gak bisa diakses!${NC}"
    echo ""
    read -p "Tekan Enter untuk kembali..."
    return
  else
    echo -e "   ${GREEN}âœ“ Sukses${NC}"
    echo -e "   ${CYAN}IP: $IP${NC}"
  fi
  
  echo ""
  
  # Ping Test
  echo -e "${WHITE}2. Ping Test:${NC}"
  PING_TIME=$(ping_test "$TARGET_HOST")
  
  if [ -z "$PING_TIME" ]; then
    echo -e "   ${RED}âŒ Gagal - Host unreachable${NC}"
    echo ""
    echo -e "${RED}${BOLD}Target host DOWN atau gak bisa diakses!${NC}"
  else
    echo -e "   ${GREEN}âœ“ Sukses${NC}"
    echo -e "   ${CYAN}Response time: ${PING_TIME}ms${NC}"
    echo ""
    echo -e "${GREEN}${BOLD}âœ… Target host UP dan berjalan normal!${NC}"
  fi
  
  echo ""
  read -p "Tekan Enter untuk kembali..."
}

# Fetch subdomains from crt.sh
fetch_crtsh() {
  local DOMAIN=$1
  local OUTPUT=$2
  
  echo -e "${CYAN}ğŸŒ Scanning subdomains for: ${WHITE}$DOMAIN${NC}"
  echo ""
  
  # Query crt.sh
  local API_URL="https://crt.sh/?q=%.${DOMAIN}&output=json"
  
  if ! curl -s --max-time 60 "$API_URL" -o "$OUTPUT.json" 2>/dev/null; then
    echo -e "${RED}${BOLD}âŒ Scan gagal${NC}"
    echo -e "${YELLOW}Kemungkinan:${NC}"
    echo -e "  ${WHITE}â€¢${NC} Gak ada koneksi internet"
    echo -e "  ${WHITE}â€¢${NC} Service scan sedang down"
    echo -e "  ${WHITE}â€¢${NC} Request timeout"
    return 1
  fi
  
  if [ ! -s "$OUTPUT.json" ]; then
    echo -e "${RED}${BOLD}âŒ Gak ada data ditemukan${NC}"
    echo -e "${YELLOW}Domain mungkin gak terdaftar atau gak ada certificate.${NC}"
    rm -f "$OUTPUT.json"
    return 1
  fi
  
  echo -e "${GREEN}âœ… Data berhasil diambil${NC}"
  echo ""
  
  # Parse JSON and extract unique subdomains
  echo -e "${CYAN}ğŸ“ Parsing data...${NC}"
  
  # Extract name_value field, clean up, remove wildcards and duplicates
  grep -oP '"name_value":"[^"]*"' "$OUTPUT.json" | \
    cut -d'"' -f4 | \
    tr '[:upper:]' '[:lower:]' | \
    grep -v '^\*' | \
    sort -u > "$OUTPUT"
  
  rm -f "$OUTPUT.json"
  
  local COUNT=$(wc -l < "$OUTPUT")
  
  if [ $COUNT -eq 0 ]; then
    echo -e "${YELLOW}âš ï¸  Gak ada subdomain ditemukan${NC}"
    return 1
  fi
  
  echo -e "${GREEN}âœ… Ditemukan ${WHITE}${BOLD}$COUNT${NC}${GREEN} unique subdomains${NC}"
  echo ""
  
  return 0
}

# Test single subdomain
test_single_subdomain() {
  clear
  print_header "Test Single Subdomain"
  echo ""
  
  echo -e "${WHITE}Masukkan subdomain (contoh: cdn.nimo.tv):${NC}"
  read -p "> " SUBDOMAIN
  
  if [ -z "$SUBDOMAIN" ]; then
    echo -e "${RED}Subdomain gak boleh kosong!${NC}"
    sleep 2
    return
  fi
  
  echo ""
  echo -e "${BLUE}Target Host:${NC} ${GREEN}$TARGET_HOST${NC}"
  echo -e "${BLUE}Testing:${NC} ${YELLOW}$SUBDOMAIN${NC}"
  echo ""
  
  echo -e "${CYAN}ğŸ” Resolving DNS...${NC}"
  IP=$(resolve_to_ip "$SUBDOMAIN")
  
  if [ -z "$IP" ]; then
    echo -e "${RED}${BOLD}âŒ IP gak ditemukan untuk $SUBDOMAIN${NC}"
    echo ""
    read -p "Tekan Enter untuk lanjut..."
    return
  fi
  
  echo -e "${WHITE}   IP Address:${NC} ${BLUE}$IP${NC}"
  
  if is_cloudflare "$IP"; then
    echo -e "${WHITE}   Provider:${NC} ${CYAN}â˜ï¸  Cloudflare${NC}"
  else
    echo -e "${WHITE}   Provider:${NC} ${YELLOW}âš ï¸  Non-Cloudflare${NC}"
  fi
  
  echo ""
  
  # Ping test
  echo -e "${CYAN}ğŸ“¡ Ping test...${NC}"
  PING_TIME=$(ping_test "$SUBDOMAIN")
  
  if [ -n "$PING_TIME" ]; then
    echo -e "${WHITE}   Response time:${NC} ${GREEN}${PING_TIME}ms${NC}"
  else
    echo -e "${WHITE}   Response time:${NC} ${RED}Timeout${NC}"
  fi
  
  echo ""
  echo -e "${CYAN}ğŸ§ª Testing bug inject...${NC}"
  
  if curl -s --max-time $TIMEOUT \
    --resolve $TARGET_HOST:443:$IP \
    https://$TARGET_HOST/ -o /dev/null 2>&1; then
    echo ""
    echo -e "${GREEN}â•”â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•—${NC}"
    echo -e "${GREEN}â•‘              âœ… BUG INJECT WORKING!                  â•‘${NC}"
    echo -e "${GREEN}â•šâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•${NC}"
    echo ""
    echo -e "${WHITE}   Subdomain:${NC} ${GREEN}$SUBDOMAIN${NC}"
    echo -e "${WHITE}   IP:${NC} ${GREEN}$IP${NC}"
    echo -e "${WHITE}   Ping:${NC} ${GREEN}${PING_TIME}ms${NC}"
    echo -e "${WHITE}   Target:${NC} ${GREEN}$TARGET_HOST${NC}"
  else
    echo ""
    echo -e "${RED}â•”â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•—${NC}"
    echo -e "${RED}â•‘              âŒ BUG INJECT FAILED                    â•‘${NC}"
    echo -e "${RED}â•šâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•${NC}"
    echo ""
    echo -e "${WHITE}   Subdomain:${NC} ${RED}$SUBDOMAIN${NC}"
    echo -e "${WHITE}   IP:${NC} ${RED}$IP${NC}"
    echo -e "${WHITE}   Ping:${NC} ${YELLOW}${PING_TIME}ms${NC}"
    echo -e "${WHITE}   Alasan:${NC} ${YELLOW}Koneksi gagal atau diblokir${NC}"
  fi
  
  echo ""
  read -p "Tekan Enter untuk lanjut..."
}

# Batch test subdomains
batch_test_subdomains() {
  clear
  print_header "Batch Subdomain Test"
  echo ""
  
  echo -e "${WHITE}${BOLD}Pilih mode input:${NC}"
  echo ""
  echo -e "  ${WHITE}1.${NC} Input manual (satu per satu)"
  echo -e "  ${WHITE}2.${NC} Load dari file"
  echo -e "  ${WHITE}3.${NC} Kembali"
  echo ""
  read -p "Pilih [1-3]: " MODE
  
  case $MODE in
    1)
      # Manual input
      clear
      print_header "Batch Test - Manual Input"
      echo ""
      echo -e "${BLUE}Masukkan subdomain (satu per baris).${NC}"
      echo -e "${BLUE}Ketik ${WHITE}${BOLD}END${NC}${BLUE} untuk selesai.${NC}"
      echo ""
      
      TEMP_FILE="$CACHE_DIR/batch-manual-$(date +%s).txt"
      > "$TEMP_FILE"  # Create empty file
      
      while true; do
        read -p "> " LINE
        if [[ "$LINE" == "END" ]] || [[ "$LINE" == "end" ]]; then
          break
        fi
        if [ -n "$LINE" ]; then
          echo "$LINE" >> "$TEMP_FILE"
        fi
      done
      
      if [ ! -s "$TEMP_FILE" ]; then
        echo -e "${RED}Gak ada subdomain yang diinput!${NC}"
        sleep 2
        rm -f "$TEMP_FILE"
        return
      fi
      
      SUBDOMAIN_FILE="$TEMP_FILE"
      ;;
      
    2)
      # Load from file
      clear
      print_header "Batch Test - Load File"
      echo ""
      echo -e "${WHITE}Masukkan path file (contoh: /sdcard/subdomains.txt):${NC}"
      read -p "> " FILE_PATH
      
      if [ ! -f "$FILE_PATH" ]; then
        echo -e "${RED}File gak ditemukan: $FILE_PATH${NC}"
        sleep 2
        return
      fi
      
      SUBDOMAIN_FILE="$FILE_PATH"
      ;;
      
    3)
      return
      ;;
      
    *)
      echo -e "${RED}Pilihan gak valid!${NC}"
      sleep 1
      return
      ;;
  esac
  
  # Start batch testing
  clear
  print_header "Batch Testing"
  echo ""
  
  local TOTAL=$(wc -l < "$SUBDOMAIN_FILE")
  echo -e "${GREEN}ğŸ“š Loaded $TOTAL subdomains${NC}"
  
  show_test_warning
  
  read -p "Tekan Enter untuk mulai testing..."
  
  echo ""
  echo -e "${CYAN}ğŸ§ª Testing... Tekan ${WHITE}${BOLD}[Ctrl+C]${CYAN} untuk stop${NC}"
  echo ""
  
  WORK_BUGS=()
  FAIL_BUGS=()
  SKIPPED=0
  CURRENT=0
  START_TIME=$(date +%s)
  SCAN_CANCELLED=false
  
  trap 'handle_scan_interrupt' INT
  
  while IFS= read -r SUBDOMAIN; do
    [ -z "$SUBDOMAIN" ] && continue
    
    if [ "$SCAN_CANCELLED" = true ]; then
      break
    fi
    
    ((CURRENT++))
    PROGRESS=$((CURRENT * 100 / TOTAL))
    
    # Progress bar
    printf "\r${CYAN}Progress: ${WHITE}[%3d%%]${NC} ${BLUE}%d${NC}/${CYAN}%d${NC} " "$PROGRESS" "$CURRENT" "$TOTAL"
    
    IP=$(resolve_to_ip "$SUBDOMAIN")
    
    if [ -z "$IP" ]; then
      ((SKIPPED++))
      continue
    fi
    
    # Get ping time
    PING_TIME=$(ping_test "$SUBDOMAIN")
    
    # Clear progress line and print test result
    printf "\r\033[K"
    printf "${WHITE}[%3d%%]${NC} ${CYAN}Testing:${NC} %-40s " "$PROGRESS" "$SUBDOMAIN"
    
    if curl -s --max-time $TIMEOUT \
      --resolve $TARGET_HOST:443:$IP \
      https://$TARGET_HOST/ -o /dev/null 2>&1; then
      if [ -n "$PING_TIME" ]; then
        printf "${GREEN}âœ… ${CYAN}(${PING_TIME}ms)${NC}\n"
      else
        printf "${GREEN}âœ…${NC}\n"
      fi
      WORK_BUGS+=("$SUBDOMAIN|$IP|$PING_TIME")
    else
      if [ -n "$PING_TIME" ]; then
        printf "${RED}âŒ ${YELLOW}(${PING_TIME}ms)${NC}\n"
      else
        printf "${RED}âŒ${NC}\n"
      fi
      FAIL_BUGS+=("$SUBDOMAIN|$IP|$PING_TIME")
    fi
    
    sleep 0.05
  done < "$SUBDOMAIN_FILE"
  
  # Clear progress line
  printf "\r\033[K"
  
  trap - INT
  
  # Clean up temp file if used
  if [[ "$SUBDOMAIN_FILE" == *"batch-manual"* ]]; then
    rm -f "$SUBDOMAIN_FILE"
  fi
  
  END_TIME=$(date +%s)
  ELAPSED=$((END_TIME - START_TIME))
  
  # Results
  echo ""
  echo ""
  print_header "HASIL BATCH TEST"
  echo ""
  
  if [ "$SCAN_CANCELLED" = true ]; then
    echo -e "${YELLOW}${BOLD}Catatan: Test dibatalkan (hasil parsial)${NC}"
    echo ""
  fi
  
  if [ ${#WORK_BUGS[@]} -gt 0 ]; then
    echo -e "${GREEN}${BOLD}âœ… Working Bugs (${#WORK_BUGS[@]}):${NC}"
    echo ""
    for BUG in "${WORK_BUGS[@]}"; do
      SUBDOMAIN=$(echo $BUG | cut -d'|' -f1)
      IP=$(echo $BUG | cut -d'|' -f2)
      PING=$(echo $BUG | cut -d'|' -f3)
      echo -e "   ${GREEN}ğŸŸ¢${NC} ${WHITE}$SUBDOMAIN${NC}"
      echo -e "      ${CYAN}â””â”€ IP: $IP${NC}"
      if [ -n "$PING" ]; then
        echo -e "      ${CYAN}â””â”€ Ping: ${PING}ms${NC}"
      fi
    done
    echo ""
  else
    echo -e "${YELLOW}Gak ada working bug ditemukan${NC}"
    echo ""
  fi
  
  if [ ${#FAIL_BUGS[@]} -gt 0 ]; then
    echo -e "${RED}${BOLD}âŒ Failed Tests (${#FAIL_BUGS[@]}):${NC}"
    echo ""
    for BUG in "${FAIL_BUGS[@]}"; do
      SUBDOMAIN=$(echo $BUG | cut -d'|' -f1)
      IP=$(echo $BUG | cut -d'|' -f2)
      PING=$(echo $BUG | cut -d'|' -f3)
      echo -e "   ${RED}ğŸ”´${NC} ${WHITE}$SUBDOMAIN${NC}"
      echo -e "      ${CYAN}â””â”€ IP: $IP${NC}"
      if [ -n "$PING" ]; then
        echo -e "      ${CYAN}â””â”€ Ping: ${PING}ms${NC}"
      fi
    done
    echo ""
  fi
  
  local width=$(tput cols 2>/dev/null || echo 60)
  printf "${CYAN}"
  printf 'â”€%.0s' $(seq 1 $width)
  printf "${NC}\n"
  
  echo -e "${WHITE}${BOLD}Statistik:${NC}"
  echo ""
  echo -e "  ${BLUE}Total Tested:${NC}     ${WHITE}$CURRENT${NC}"
  echo -e "  ${BLUE}No DNS/Failed:${NC}    ${YELLOW}$SKIPPED${NC}"
  echo ""
  echo -e "  ${GREEN}Working:${NC}          ${GREEN}${BOLD}${#WORK_BUGS[@]}${NC}"
  echo -e "  ${RED}Failed:${NC}           ${RED}${#FAIL_BUGS[@]}${NC}"
  echo ""
  echo -e "  ${BLUE}Waktu:${NC}            ${CYAN}${ELAPSED}s${NC}"
  echo ""
  
  if [ ${#WORK_BUGS[@]} -gt 0 ] || [ ${#FAIL_BUGS[@]} -gt 0 ]; then
    echo -e "${WHITE}Export hasil? (y/n):${NC}"
    read -p "> " EXPORT
    if [[ "$EXPORT" =~ ^[Yy]$ ]]; then
      OUTPUT="$RESULTS_DIR/batch-$(date +%Y%m%d-%H%M%S).txt"
      {
        echo "# InjectTools Batch Test Results"
        echo "# Created by: t.me/hoshiyomi_id"
        echo "# Date: $(date)"
        echo "# "
        echo "# Statistics:"
        echo "# - Total tested: $CURRENT"
        echo "# - No DNS/Failed: $SKIPPED"
        echo "# - Test time: ${ELAPSED}s"
        [ "$SCAN_CANCELLED" = true ] && echo "# - Status: Cancelled (partial)"
        echo ""
        [ ${#WORK_BUGS[@]} -gt 0 ] && {
          echo "=== WORKING BUGS (${#WORK_BUGS[@]}) ===";
          echo ""
          for B in "${WORK_BUGS[@]}"; do 
            SUB=$(echo $B | cut -d'|' -f1)
            IP=$(echo $B | cut -d'|' -f2)
            PING=$(echo $B | cut -d'|' -f3)
            echo "âœ… $SUB"
            echo "   IP: $IP"
            [ -n "$PING" ] && echo "   Ping: ${PING}ms"
            echo ""
          done
        }
        [ ${#FAIL_BUGS[@]} -gt 0 ] && {
          echo "=== FAILED TESTS (${#FAIL_BUGS[@]}) ===";
          echo ""
          for B in "${FAIL_BUGS[@]}"; do 
            SUB=$(echo $B | cut -d'|' -f1)
            IP=$(echo $B | cut -d'|' -f2)
            PING=$(echo $B | cut -d'|' -f3)
            echo "âŒ $SUB"
            echo "   IP: $IP"
            [ -n "$PING" ] && echo "   Ping: ${PING}ms"
            echo ""
          done
        }
      } > "$OUTPUT"
      echo -e "${GREEN}${BOLD}âœ… Tersimpan: $OUTPUT${NC}"
      sleep 2
    fi
  fi
  
  echo ""
  read -p "Tekan Enter untuk kembali ke menu..."
}

# Handle Ctrl+C during scan
handle_scan_interrupt() {
  SCAN_CANCELLED=true
  echo ""
  echo -e "${YELLOW}${BOLD}âš ï¸  Scan dibatalkan oleh user (Ctrl+C)${NC}"
}

# Test subdomains from scan
test_subdomains() {
  local WORDLIST_FILE=$1
  local DOMAIN=$2
  
  clear
  print_header "Testing Subdomains"
  echo ""
  
  echo -e "${BLUE}Domain:${NC}   ${GREEN}$DOMAIN${NC}"
  echo -e "${BLUE}Target:${NC}   ${GREEN}$TARGET_HOST${NC}"
  echo -e "${BLUE}Filter:${NC}   ${CYAN}â˜ï¸  Cloudflare only${NC}"
  echo ""
  
  local TOTAL=$(wc -l < "$WORDLIST_FILE")
  echo -e "${GREEN}ğŸ“š Loaded $TOTAL subdomains${NC}"
  
  show_test_warning
  
  read -p "Tekan Enter untuk mulai testing..."
  
  echo ""
  echo -e "${CYAN}ğŸ§ª Testing... Tekan ${WHITE}${BOLD}[Ctrl+C]${CYAN} untuk stop${NC}"
  echo ""
  
  WORK_BUGS=()
  FAIL_BUGS=()
  SKIPPED=0
  CF_TESTED=0
  CURRENT=0
  START_TIME=$(date +%s)
  SCAN_CANCELLED=false
  
  trap 'handle_scan_interrupt' INT
  
  while IFS= read -r SUBDOMAIN; do
    [ -z "$SUBDOMAIN" ] && continue
    
    if [ "$SCAN_CANCELLED" = true ]; then
      break
    fi
    
    ((CURRENT++))
    PROGRESS=$((CURRENT * 100 / TOTAL))
    
    # Progress bar - overwrite line
    printf "\r${CYAN}Progress: ${WHITE}[%3d%%]${NC} ${BLUE}%d${NC}/${CYAN}%d${NC} " "$PROGRESS" "$CURRENT" "$TOTAL"
    
    IP=$(resolve_to_ip "$SUBDOMAIN")
    
    if [ -z "$IP" ]; then
      ((SKIPPED++))
      continue
    fi
    
    if ! is_cloudflare "$IP"; then
      ((SKIPPED++))
      continue
    fi
    
    # Get ping time
    PING_TIME=$(ping_test "$SUBDOMAIN")
    
    # Clear progress line and print test result
    printf "\r\033[K"
    printf "${WHITE}[%3d%%]${NC} ${CYAN}Testing:${NC} %-40s " "$PROGRESS" "$SUBDOMAIN"
    
    ((CF_TESTED++))
    
    if curl -s --max-time $TIMEOUT \
      --resolve $TARGET_HOST:443:$IP \
      https://$TARGET_HOST/ -o /dev/null 2>&1; then
      if [ -n "$PING_TIME" ]; then
        printf "${GREEN}âœ… ${CYAN}(${PING_TIME}ms)${NC}\n"
      else
        printf "${GREEN}âœ…${NC}\n"
      fi
      WORK_BUGS+=("$SUBDOMAIN|$IP|$PING_TIME")
    else
      if [ -n "$PING_TIME" ]; then
        printf "${RED}âŒ ${YELLOW}(${PING_TIME}ms)${NC}\n"
      else
        printf "${RED}âŒ${NC}\n"
      fi
      FAIL_BUGS+=("$SUBDOMAIN|$IP|$PING_TIME")
    fi
    
    sleep 0.05
  done < "$WORDLIST_FILE"
  
  # Clear progress line
  printf "\r\033[K"
  
  trap - INT
  
  END_TIME=$(date +%s)
  ELAPSED=$((END_TIME - START_TIME))
  
  # Results
  echo ""
  echo ""
  print_header "HASIL SCAN"
  echo ""
  
  if [ "$SCAN_CANCELLED" = true ]; then
    echo -e "${YELLOW}${BOLD}Catatan: Scan dibatalkan (hasil parsial)${NC}"
    echo ""
  fi
  
  if [ ${#WORK_BUGS[@]} -gt 0 ]; then
    echo -e "${GREEN}${BOLD}âœ… Working Bugs (${#WORK_BUGS[@]}):${NC}"
    echo ""
    for BUG in "${WORK_BUGS[@]}"; do
      SUBDOMAIN=$(echo $BUG | cut -d'|' -f1)
      IP=$(echo $BUG | cut -d'|' -f2)
      PING=$(echo $BUG | cut -d'|' -f3)
      echo -e "   ${GREEN}ğŸŸ¢${NC} ${WHITE}$SUBDOMAIN${NC}"
      echo -e "      ${CYAN}â””â”€ IP: $IP${NC}"
      if [ -n "$PING" ]; then
        echo -e "      ${CYAN}â””â”€ Ping: ${PING}ms${NC}"
      fi
    done
    echo ""
  else
    echo -e "${YELLOW}Gak ada working bug ditemukan${NC}"
    echo ""
  fi
  
  if [ ${#FAIL_BUGS[@]} -gt 0 ]; then
    echo -e "${RED}${BOLD}âŒ Failed Tests (${#FAIL_BUGS[@]}):${NC}"
    echo ""
    for BUG in "${FAIL_BUGS[@]}"; do
      SUBDOMAIN=$(echo $BUG | cut -d'|' -f1)
      IP=$(echo $BUG | cut -d'|' -f2)
      PING=$(echo $BUG | cut -d'|' -f3)
      echo -e "   ${RED}ğŸ”´${NC} ${WHITE}$SUBDOMAIN${NC}"
      echo -e "      ${CYAN}â””â”€ IP: $IP${NC}"
      if [ -n "$PING" ]; then
        echo -e "      ${CYAN}â””â”€ Ping: ${PING}ms${NC}"
      fi
    done
    echo ""
  fi
  
  local width=$(tput cols 2>/dev/null || echo 60)
  printf "${CYAN}"
  printf 'â”€%.0s' $(seq 1 $width)
  printf "${NC}\n"
  
  echo -e "${WHITE}${BOLD}Statistik Scan:${NC}"
  echo ""
  echo -e "  ${BLUE}Total Subdomains:${NC}     ${WHITE}$TOTAL${NC}"
  echo -e "  ${BLUE}Cloudflare Found:${NC}     ${CYAN}$CF_TESTED${NC}"
  echo -e "  ${BLUE}Non-CF/No DNS:${NC}        ${YELLOW}$SKIPPED${NC}"
  echo ""
  echo -e "  ${GREEN}Working:${NC}              ${GREEN}${BOLD}${#WORK_BUGS[@]}${NC}"
  echo -e "  ${RED}Failed:${NC}                ${RED}${#FAIL_BUGS[@]}${NC}"
  echo ""
  echo -e "  ${BLUE}Total Tested:${NC}         ${WHITE}$CF_TESTED${NC} Cloudflare subdomains"
  echo -e "  ${BLUE}Waktu:${NC}                ${CYAN}${ELAPSED}s${NC}"
  echo ""
  
  if [ ${#WORK_BUGS[@]} -gt 0 ] || [ ${#FAIL_BUGS[@]} -gt 0 ]; then
    echo -e "${WHITE}Export hasil? (y/n):${NC}"
    read -p "> " EXPORT
    if [[ "$EXPORT" =~ ^[Yy]$ ]]; then
      OUTPUT="$RESULTS_DIR/fullscan-$DOMAIN-$(date +%Y%m%d-%H%M%S).txt"
      {
        echo "# InjectTools Full Scan Results"
        echo "# Created by: t.me/hoshiyomi_id"
        echo "# Domain: $DOMAIN"
        echo "# Date: $(date)"
        echo "# "
        echo "# Statistics:"
        echo "# - Total subdomains: $TOTAL"
        echo "# - Cloudflare found: $CF_TESTED"
        echo "# - Non-CF/No DNS: $SKIPPED"
        echo "# - Scan time: ${ELAPSED}s"
        [ "$SCAN_CANCELLED" = true ] && echo "# - Status: Cancelled (partial)"
        echo ""
        [ ${#WORK_BUGS[@]} -gt 0 ] && {
          echo "=== WORKING BUGS (${#WORK_BUGS[@]}) ===";
          echo ""
          for B in "${WORK_BUGS[@]}"; do 
            SUB=$(echo $B | cut -d'|' -f1)
            IP=$(echo $B | cut -d'|' -f2)
            PING=$(echo $B | cut -d'|' -f3)
            echo "âœ… $SUB"
            echo "   IP: $IP"
            [ -n "$PING" ] && echo "   Ping: ${PING}ms"
            echo ""
          done
        }
        [ ${#FAIL_BUGS[@]} -gt 0 ] && {
          echo "=== FAILED TESTS (${#FAIL_BUGS[@]}) ===";
          echo ""
          for B in "${FAIL_BUGS[@]}"; do 
            SUB=$(echo $B | cut -d'|' -f1)
            IP=$(echo $B | cut -d'|' -f2)
            PING=$(echo $B | cut -d'|' -f3)
            echo "âŒ $SUB"
            echo "   IP: $IP"
            [ -n "$PING" ] && echo "   Ping: ${PING}ms"
            echo ""
          done
        }
      } > "$OUTPUT"
      echo -e "${GREEN}${BOLD}âœ… Tersimpan: $OUTPUT${NC}"
      sleep 2
    fi
  fi
  
  echo ""
  read -p "Tekan Enter untuk kembali ke menu..."
}

# Full scan (with error handling)
full_scan() {
  while true; do
    clear
    print_header "Full Scan"
    echo ""
    
    echo -e "${WHITE}Masukkan target domain (contoh: nimo.tv, cloudflare.com):${NC}"
    read -p "> " TARGET_DOMAIN
    
    if [ -z "$TARGET_DOMAIN" ]; then
      echo -e "${RED}Domain gak boleh kosong!${NC}"
      sleep 2
      continue
    fi
    
    echo ""
    echo -e "${CYAN}â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”${NC}"
    echo ""
    
    # Fetch from crt.sh
    clear
    print_header "Scanning Subdomains"
    echo ""
    
    local TIMESTAMP=$(date +%Y%m%d-%H%M%S)
    local CACHE_FILE="$CACHE_DIR/fullscan-$TARGET_DOMAIN-$TIMESTAMP.txt"
    
    if ! fetch_crtsh "$TARGET_DOMAIN" "$CACHE_FILE"; then
      echo ""
      echo -e "${CYAN}â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”${NC}"
      echo ""
      echo -e "${WHITE}${BOLD}Pilih aksi:${NC}"
      echo ""
      echo -e "  ${WHITE}1.${NC} Retry dengan domain yang sama"
      echo -e "  ${WHITE}2.${NC} Coba domain lain"
      echo -e "  ${WHITE}3.${NC} Kembali ke menu"
      echo ""
      read -p "Pilih [1-3]: " RETRY_CHOICE
      
      case $RETRY_CHOICE in
        1)
          continue
          ;;
        2)
          full_scan
          return
          ;;
        3)
          return
          ;;
        *)
          return
          ;;
      esac
    fi
    
    echo -e "${CYAN}â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”${NC}"
    echo ""
    echo -e "${GREEN}${BOLD}âœ… Subdomain list tersimpan${NC}"
    echo ""
    
    local TOTAL=$(wc -l < "$CACHE_FILE")
    echo -e "${CYAN}Total subdomains: ${WHITE}${BOLD}$TOTAL${NC}"
    echo ""
    read -p "Tekan Enter untuk lanjut ke testing..."
    
    # Test phase
    test_subdomains "$CACHE_FILE" "$TARGET_DOMAIN"
    break
  done
}

# Settings
settings_menu() {
  clear
  print_header "SETTINGS"
  echo ""
  
  echo -e "${WHITE}${BOLD}Config saat ini:${NC}"
  echo -e "  ${BLUE}Target Host:${NC} ${GREEN}$TARGET_HOST${NC}"
  echo -e "  ${BLUE}Timeout:${NC} ${CYAN}${TIMEOUT}s${NC}"
  echo -e "  ${BLUE}Data Directory:${NC} ${CYAN}$BASE_DIR${NC}"
  echo ""
  echo -e "  ${WHITE}1.${NC} Ubah Target Host"
  echo -e "  ${WHITE}2.${NC} Ubah Timeout"
  echo -e "  ${WHITE}3.${NC} Setup Ulang"
  echo -e "  ${WHITE}4.${NC} Kembali"
  echo ""
  read -p "Pilih [1-4]: " opt
  
  case $opt in
    1)
      echo -e "${WHITE}Target host baru:${NC}"
      read -p "> " NEW_HOST
      if [ -n "$NEW_HOST" ]; then
        TARGET_HOST=$NEW_HOST
        save_config
      fi
      sleep 1
      settings_menu
      ;;
    2)
      echo -e "${WHITE}Timeout (detik):${NC}"
      read -p "> " NEW_TIMEOUT
      if [[ "$NEW_TIMEOUT" =~ ^[0-9]+$ ]]; then
        TIMEOUT=$NEW_TIMEOUT
        save_config
      fi
      sleep 1
      settings_menu
      ;;
    3)
      first_time_setup
      ;;
    4) return ;;
  esac
}

# Main menu
main_menu() {
  while true; do
    clear
    print_header "InjectTools v2.3"
    echo ""
    echo -e "${CYAN}Created by: t.me/hoshiyomi_id${NC}"
    echo ""
    echo -e "${BLUE}Target Host:${NC} ${GREEN}$TARGET_HOST${NC}"
    echo ""
    local width=$(tput cols 2>/dev/null || echo 60)
    printf "${CYAN}"
    printf 'â”€%.0s' $(seq 1 $width)
    printf "${NC}\n"
    echo ""
    echo -e "${WHITE}${BOLD}Menu:${NC}"
    echo ""
    echo -e "  ${WHITE}1.${NC} Single Subdomain Test"
    echo -e "  ${WHITE}2.${NC} Batch Subdomain Test"
    echo -e "  ${WHITE}3.${NC} Full Scan"
    echo -e "  ${WHITE}4.${NC} View Scan Results"
    echo -e "  ${WHITE}5.${NC} Test Target Host"
    echo -e "  ${WHITE}6.${NC} Settings"
    echo -e "  ${WHITE}7.${NC} Exit"
    echo ""
    read -p "Pilih [1-7]: " choice
    
    case $choice in
      1) test_single_subdomain ;;
      2) batch_test_subdomains ;;
      3) full_scan ;;
      4) view_exported_results ;;
      5) test_target_host ;;
      6) settings_menu ;;
      7) 
        clear
        echo -e "${GREEN}${BOLD}Sampai jumpa!${NC}"
        echo -e "${CYAN}Created by: t.me/hoshiyomi_id${NC}"
        echo ""
        exit 0
        ;;
      *) echo -e "${RED}${BOLD}Pilihan gak valid!${NC}"; sleep 1 ;;
    esac
  done
}

# Main execution
check_dependencies

if ! load_config; then
  first_time_setup
fi

main_menu
